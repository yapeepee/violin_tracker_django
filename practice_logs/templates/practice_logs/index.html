{% extends "practice_logs/base.html" %}
{% load static %}

{% block extra_css %}
<!-- ç„¡éœ€é¡å¤– CSSï¼Œç”± base.html çµ±ä¸€ç®¡ç† -->
{% endblock %}

{% block content %}
<!-- A. Hero å€ (100vh) - ç¬¦åˆè—åœ–è¦ç¯„ -->
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <!-- å·¦æ–‡ -->
            <div class="hero-text">
                <h1 class="hero-title">ğŸµ è®“ç·´ç¿’æ›´æœ‰æ•ˆç‡</h1>
                <p class="hero-subtitle">ç§‘å­¸åŒ–è¿½è¹¤æ‚¨çš„éŸ³æ¨‚å­¸ç¿’æ—…ç¨‹ï¼Œæ¯å¤©éƒ½çœ‹å¾—è¦‹é€²æ­¥</p>
                <a href="#practice-form" class="hero-cta">ç«‹å³é–‹å§‹è¨˜éŒ„ â†’</a>
                
                <!-- å³æ™‚æ•¸æ“šå±•ç¤º -->
                <div class="flex gap-8 mt-12">
                    <div>
                        <div class="text-3xl font-bold text-primary-color">2,847+</div>
                        <div class="text-sm text-gray-600">æ´»èºéŸ³æ¨‚å®¶</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-primary-color">158K</div>
                        <div class="text-sm text-gray-600">ç´¯è¨ˆç·´ç¿’æ™‚æ•¸</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-primary-color">98%</div>
                        <div class="text-sm text-gray-600">é€²æ­¥æ»¿æ„åº¦</div>
                    </div>
                </div>
            </div>
            
            <!-- å³åœ– -->
            <div class="hero-image">
                <!-- éŸ³æ¨‚å…ƒç´ è£é£¾ -->
                <div class="relative w-full h-full flex items-center justify-center">
                    <div class="text-9xl opacity-10 absolute top-0 right-0 animate-float">ğŸ»</div>
                    <div class="text-8xl opacity-10 absolute bottom-0 left-0 animate-float" style="animation-delay: -2s;">ğŸ¸</div>
                    <div class="text-7xl opacity-10 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 animate-float" style="animation-delay: -4s;">ğŸµ</div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- B. Trust å€ (600-800px) - ç¤¾æœƒèªåŒ -->
<section class="trust-section section">
    <div class="container">
        <h2 class="text-center text-4xl font-bold mb-12">å—åˆ°éŸ³æ¨‚å®¶å€‘çš„ä¿¡è³´</h2>
        
        <!-- Logo æ»¾å‹•åˆ— -->
        <div class="trust-logos">
            <span class="trust-logo text-5xl opacity-60">ğŸ¼ å°åŒ—éŸ³æ¨‚å­¸é™¢</span>
            <span class="trust-logo text-5xl opacity-60">ğŸ» åœ‹å®¶äº¤éŸ¿æ¨‚åœ˜</span>
            <span class="trust-logo text-5xl opacity-60">ğŸ· ä¸­è¯éŸ³æ¨‚å”æœƒ</span>
            <span class="trust-logo text-5xl opacity-60">ğŸº å°ç£ç®¡æ¨‚åœ˜</span>
        </div>
        
        <!-- è©•åƒ¹å¡ç‰‡ -->
        <div class="testimonials-grid">
            <div class="testimonial-card">
                <div class="testimonial-rating">â˜…â˜…â˜…â˜…â˜…</div>
                <p class="testimonial-text">"é€™å€‹ç³»çµ±è®“æˆ‘å¯ä»¥æ¸…æ¥šçœ‹åˆ°å­¸ç”Ÿçš„é€²æ­¥ï¼Œéå¸¸å¯¦ç”¨ï¼"</p>
                <div class="testimonial-author">
                    <div class="author-avatar bg-warm-brown text-white flex items-center justify-center text-xl font-bold">é™³</div>
                    <div class="author-info">
                        <h4>é™³è€å¸«</h4>
                        <p>å°æç´æ•™å¸«</p>
                    </div>
                </div>
            </div>
            
            <div class="testimonial-card">
                <div class="testimonial-rating">â˜…â˜…â˜…â˜…â˜…</div>
                <p class="testimonial-text">"æ¯å¤©è¨˜éŒ„ç·´ç¿’ï¼Œè®“æˆ‘çš„é€²æ­¥å¯ä»¥é‡åŒ–ï¼ŒçœŸçš„å¾ˆæ£’ï¼"</p>
                <div class="testimonial-author">
                    <div class="author-avatar bg-warm-brown text-white flex items-center justify-center text-xl font-bold">æ—</div>
                    <div class="author-info">
                        <h4>æ—åŒå­¸</h4>
                        <p>éŸ³æ¨‚ç³»å­¸ç”Ÿ</p>
                    </div>
                </div>
            </div>
            
            <div class="testimonial-card">
                <div class="testimonial-rating">â˜…â˜…â˜…â˜…â˜…</div>
                <p class="testimonial-text">"å­©å­æ›´æœ‰å‹•åŠ›ç·´ç¿’ï¼Œå› ç‚ºä»–å¯ä»¥çœ‹åˆ°è‡ªå·±çš„æˆé•·æ›²ç·š"</p>
                <div class="testimonial-author">
                    <div class="author-avatar bg-warm-brown text-white flex items-center justify-center text-xl font-bold">å¼µ</div>
                    <div class="author-info">
                        <h4>å¼µåª½åª½</h4>
                        <p>å­¸ç”Ÿå®¶é•·</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- C. Feature å€ - åŠŸèƒ½æ¨¡çµ„ -->
<section class="feature-section">
    <div class="container">
        <h2 class="text-center text-4xl font-bold mb-4">å…¨æ–¹ä½ç·´ç¿’ç®¡ç†</h2>
        <p class="text-center text-xl text-gray-600 mb-12">è®“æ¯ä¸€æ¬¡ç·´ç¿’éƒ½æ›´æœ‰æ„ç¾©</p>
        
        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-icon">ğŸ“Š</div>
                <h3 class="feature-title">æ™ºæ…§åˆ†æ</h3>
                <p class="feature-description">è¦–è¦ºåŒ–åœ–è¡¨å±•ç¤ºç·´ç¿’æˆæœï¼Œè®“é€²æ­¥ä¸€ç›®äº†ç„¶</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">â±ï¸</div>
                <h3 class="feature-title">æ™‚é–“è¿½è¹¤</h3>
                <p class="feature-description">ç²¾æº–è¨˜éŒ„æ¯æ¬¡ç·´ç¿’æ™‚é–“ï¼ŒåŸ¹é¤Šè¦å¾‹çš„ç·´ç¿’ç¿’æ…£</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">ğŸ¯</div>
                <h3 class="feature-title">ç›®æ¨™è¨­å®š</h3>
                <p class="feature-description">è¨­å®šå€‹äººåŒ–çš„ç·´ç¿’ç›®æ¨™ï¼Œé€æ­¥å®ŒæˆéŸ³æ¨‚å¤¢æƒ³</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">ğŸ“</div>
                <h3 class="feature-title">è©³ç´°ç­†è¨˜</h3>
                <p class="feature-description">è¨˜éŒ„ç·´ç¿’å¿ƒå¾—èˆ‡é‡é»ï¼Œç‚ºæœªä¾†ç·´ç¿’æä¾›åƒè€ƒ</p>
            </div>
        </div>
    </div>
</section>

<div class="container">

    <!-- éŒ¯èª¤æç¤ºå€åŸŸ -->
    <div id="errorAlert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <span id="errorMessage"></span>
        <button type="button" class="absolute top-0 right-0 px-4 py-3" onclick="document.getElementById('errorAlert').classList.add('hidden')">
            <span class="text-2xl">&times;</span>
        </button>
    </div>

    <!-- ç·´ç¿’è¡¨å–®å€å¡Š -->
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8 mb-16" id="practice-form">
        <form method='POST' id="practiceForm">
            {% csrf_token %}
            
            <!-- éš±è—çš„å­¸ç”Ÿå§“åæ¬„ä½ -->
            <input type="hidden" name="student_name" id="studentName" value="{{ current_student|default:user.username }}">
            
            <!-- è¡¨å–®æ¨™é¡Œ -->
            <h3 class="text-3xl font-bold text-center mb-8 text-warm-brown">é–‹å§‹è¨˜éŒ„ä»Šå¤©çš„ç·´ç¿’</h3>
            
            <!-- ç·´ç¿’æ—¥æœŸ -->
            <div class="mb-6">
                <label for="practiceDate" class="block text-base font-semibold text-gray-700 mb-2">
                    <i class="fas fa-calendar-alt mr-2 text-warm-brown"></i>
                    ç·´ç¿’æ—¥æœŸ
                </label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zM4 8h12v8H4V8z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <input type="date" 
                           name="date" 
                           id="practiceDate" 
                           class="form-input pl-10" 
                           required>
                </div>
            </div>

            <!-- æ¨‚å™¨é¸æ“‡å€ -->
            <div class="mb-6">
                <label for="id_instrument" class="block text-base font-semibold text-gray-700 mb-2">
                    <i class="fas fa-music mr-2 text-warm-brown"></i>
                    é¸æ“‡ç·´ç¿’æ¨‚å™¨
                </label>
                <select name="instrument" id="id_instrument" 
                        class="form-input text-base p-3" 
                        required>
                    <option value="" selected>è«‹é¸æ“‡æ¨‚å™¨...</option>
                    <optgroup label="å¼¦æ¨‚å™¨">
                        <option value="violin">ğŸ» å°æç´</option>
                        <option value="viola">ğŸ» ä¸­æç´</option>
                        <option value="cello">ğŸ» å¤§æç´</option>
                        <option value="double_bass">ğŸ» ä½éŸ³æç´</option>
                        <option value="guitar">ğŸ¸ å‰ä»–</option>
                        <option value="bass">ğŸ¸ è²æ–¯</option>
                        <option value="ukulele">ğŸ¸ çƒå…‹éº—éº—</option>
                        <option value="harp">ğŸµ è±ç´</option>
                    </optgroup>
                    <optgroup label="ç®¡æ¨‚å™¨">
                        <option value="flute">ğŸµ é•·ç¬›</option>
                        <option value="clarinet">ğŸµ å–®ç°§ç®¡</option>
                        <option value="oboe">ğŸµ é›™ç°§ç®¡</option>
                        <option value="saxophone">ğŸ· è–©å…‹æ–¯é¢¨</option>
                        <option value="trumpet">ğŸº å°è™Ÿ</option>
                        <option value="trombone">ğŸº é•·è™Ÿ</option>
                        <option value="french_horn">ğŸº æ³•åœ‹è™Ÿ</option>
                    </optgroup>
                    <optgroup label="å…¶ä»–">
                        <option value="piano">ğŸ¹ é‹¼ç´</option>
                        <option value="drums">ğŸ¥ çˆµå£«é¼“</option>
                        <option value="voice">ğŸ¤ è²æ¨‚</option>
                    </optgroup>
                </select>
                <p class="mt-2 text-sm text-gray-500">è«‹é¸æ“‡æ‚¨ä»Šå¤©è¦ç·´ç¿’çš„æ¨‚å™¨</p>
            </div>

            <!-- ç·´ç¿’æ›²ç›® -->
            <div class="mb-6">
                <label for="piece" class="block text-base font-semibold text-gray-700 mb-2">
                    <i class="fas fa-music mr-2 text-warm-brown"></i>
                    ç·´ç¿’æ›²ç›® *
                </label>
                <input type="text" 
                       name="piece" 
                       id="piece"
                       class="form-input text-lg py-4 border-2 hover:border-warm-brown" 
                       placeholder="ä¾‹å¦‚ï¼šå·´å“ˆç„¡ä¼´å¥çµ„æ›²ç¬¬ä¸€è™Ÿ" 
                       required 
                       maxlength="100">
                <p class="mt-2 text-sm text-gray-600 italic">è«‹è¼¸å…¥ä»Šå¤©ä¸»è¦ç·´ç¿’çš„æ¨‚æ›²åç¨±</p>
            </div>
            
            <!-- ç·´ç¿’æ™‚é–“ - è¼ƒå°æ¬„ä½ -->
            <div class="mb-6">
                <label for="minutes" class="block text-sm font-medium text-dark-brown mb-2">ç·´ç¿’æ™‚é–“</label>
                <div class="flex items-center max-w-xs">
                    <input type="number" 
                           name="minutes" 
                           id="minutes"
                           class="w-24 px-3 py-2 text-center border border-beige rounded-l-lg focus:ring-2 focus:ring-warm-brown focus:border-transparent" 
                           placeholder="30" 
                           min="1" 
                           max="600" 
                           required>
                    <span class="px-4 py-2 bg-beige text-dark-brown rounded-r-lg border border-l-0 border-beige">åˆ†é˜</span>
                </div>
            </div>

            <!-- ç·´ç¿’é‡é»å€ -->
            <div class="mb-6">
                <label class="block text-lg font-semibold text-warm-brown mb-3">ç·´ç¿’é‡é»</label>
                <div class="flex flex-wrap gap-2">
                    <input type="radio" id="focus-technique" name="focus" value="technique" class="hidden peer/technique" checked>
                    <label for="focus-technique" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/technique:bg-warm-brown peer-checked/technique:text-white transition-all">
                        ğŸ¯ æŠ€å·§ç·´ç¿’
                    </label>
                    
                    <input type="radio" id="focus-expression" name="focus" value="expression" class="hidden peer/expression">
                    <label for="focus-expression" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/expression:bg-warm-brown peer-checked/expression:text-white transition-all">
                        ğŸ­ è¡¨ç¾åŠ›
                    </label>
                    
                    <input type="radio" id="focus-rhythm" name="focus" value="rhythm" class="hidden peer/rhythm">
                    <label for="focus-rhythm" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/rhythm:bg-warm-brown peer-checked/rhythm:text-white transition-all">
                        ğŸ¥ ç¯€å¥
                    </label>
                    
                    <input type="radio" id="focus-sight" name="focus" value="sight_reading" class="hidden peer/sight">
                    <label for="focus-sight" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/sight:bg-warm-brown peer-checked/sight:text-white transition-all">
                        ğŸ‘ï¸ è¦–å¥
                    </label>
                    
                    <input type="radio" id="focus-memory" name="focus" value="memorization" class="hidden peer/memory">
                    <label for="focus-memory" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/memory:bg-warm-brown peer-checked/memory:text-white transition-all">
                        ğŸ§  è¨˜è­œ
                    </label>
                    
                    <input type="radio" id="focus-ensemble" name="focus" value="ensemble" class="hidden peer/ensemble">
                    <label for="focus-ensemble" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/ensemble:bg-warm-brown peer-checked/ensemble:text-white transition-all">
                        ğŸ‘¥ é‡å¥
                    </label>
                    
                    <input type="radio" id="focus-other" name="focus" value="other" class="hidden peer/other">
                    <label for="focus-other" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/other:bg-warm-brown peer-checked/other:text-white transition-all">
                        âœ¨ å…¶ä»–
                    </label>
                </div>
                <p class="mt-3 text-sm text-gray-500">é¸æ“‡æœ¬æ¬¡ç·´ç¿’çš„ä¸»è¦é‡é»</p>
            </div>

            <!-- ç²¾ç·»è©•åˆ†ç³»çµ± -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-dark-brown mb-4">ç·´ç¿’è©•åˆ† *</label>
                <div class="max-w-sm mx-auto">
                    <!-- è¿·ä½ é‹¼ç´ -->
                    <div class="flex justify-center gap-0.5 mb-6">
                        <div class="piano-key w-8 h-12 bg-white border border-gray-300 rounded-b-sm cursor-pointer hover:bg-gray-100 transition-all duration-200" data-rating="1"></div>
                        <div class="piano-key w-8 h-12 bg-white border border-gray-300 rounded-b-sm cursor-pointer hover:bg-gray-100 transition-all duration-200" data-rating="2"></div>
                        <div class="piano-key w-8 h-12 bg-white border border-gray-300 rounded-b-sm cursor-pointer hover:bg-gray-100 transition-all duration-200" data-rating="3"></div>
                        <div class="piano-key w-8 h-12 bg-white border border-gray-300 rounded-b-sm cursor-pointer hover:bg-gray-100 transition-all duration-200" data-rating="4"></div>
                        <div class="piano-key w-8 h-12 bg-white border border-gray-300 rounded-b-sm cursor-pointer hover:bg-gray-100 transition-all duration-200" data-rating="5"></div>
                    </div>
                    
                    <!-- å„ªé›…æ»‘æ¡¿ -->
                    <div class="relative mb-8">
                        <div class="w-full h-1 bg-beige rounded-full">
                            <div id="sliderFill" class="h-full bg-warm-brown rounded-full transition-all duration-300" style="width: 50%"></div>
                        </div>
                        <input type="range" 
                               id="ratingSlider" 
                               class="absolute w-full h-1 top-0 opacity-0 cursor-pointer" 
                               min="1" 
                               max="5" 
                               value="3" 
                               step="1">
                        <div class="flex justify-between mt-2 text-xs text-gray-500">
                            <span>1</span>
                            <span>2</span>
                            <span>3</span>
                            <span>4</span>
                            <span>5</span>
                        </div>
                    </div>
                    
                    <!-- è©•åˆ†æ–‡å­— -->
                    <div class="text-center">
                        <span class="text-2xl font-bold text-warm-brown" id="ratingValue">3</span>
                        <span class="text-dark-brown"> åˆ† - </span>
                        <span class="text-warm-brown italic" id="ratingDesc">æ™®é€š</span>
                    </div>
                </div>
                <input type="hidden" id="rating" name="rating" value="3" required>
            </div>

            <!-- ç·´ç¿’ç­†è¨˜ -->
            <div class="mb-8">
                <label for="notes" class="block text-sm font-medium text-dark-brown mb-2">ç·´ç¿’ç­†è¨˜</label>
                <textarea name="notes" 
                          id="notes"
                          class="w-full px-4 py-3 border border-beige rounded-lg focus:ring-2 focus:ring-warm-brown focus:border-transparent transition-all duration-200 resize-none" 
                          rows="4" 
                          placeholder="è¨˜éŒ„ä»Šå¤©çš„ç·´ç¿’å…§å®¹ã€æ„Ÿå—ã€éœ€è¦æ”¹é€²çš„åœ°æ–¹æˆ–ä¸‹æ¬¡ç·´ç¿’çš„é‡é»..." 
                          maxlength="1000"></textarea>
                <p class="mt-2 text-sm text-gray-600 italic">è©³ç´°è¨˜éŒ„ç·´ç¿’çš„å…§å®¹ã€æ„Ÿå—å’Œéœ€è¦æ³¨æ„çš„äº‹é …</p>
            </div>

            <!-- æäº¤æŒ‰éˆ• -->
            <div class="text-center">
                <button type="submit" class="hero-cta">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    <i class="fas fa-save mr-2"></i>
                    è¨˜éŒ„ç·´ç¿’ âœ¨
                </button>
            </div>
        </form>
    </div>

    <div class="bg-white rounded-lg p-6 shadow-warm border border-beige mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-serif text-dark-brown">ğŸµ ç·´ç¿’æ™‚é–“çµ±è¨ˆ</h2>
            <div id="analyticsLink">
                <a href="#" class="btn-primary" onclick="goToAnalytics(); return false;">
                    æŸ¥çœ‹è©³ç´°åˆ†æ ğŸ“Š
                </a>
            </div>
        </div>
        <div id="studentInfo" class="text-center text-lg text-gray-600 my-4"></div>
        <div class="relative">
            <div id="chartLoading" class="absolute inset-0 flex items-center justify-center hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-warm-brown"></div>
            </div>
            <canvas id="weeklyChart"></canvas>
        </div>
    </div>
</div>


<!-- å°‡ Django è®Šé‡å‚³éçµ¦ JavaScript -->
<script>
    window.INITIAL_STUDENT = "{{ current_student|default:'null' }}";
    window.CSRF_TOKEN = "{{ csrf_token }}";
</script>

<!-- 3Dè§’è‰²é…ç½®å·²ç§»é™¤ -->

<!-- Three.jså¼•ç”¨å·²ç§»é™¤ -->

<!-- 3Dè§’è‰²ç³»çµ±å·²ç§»é™¤ -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ç§»é™¤ç¾ä»£æ¨™ç±¤é¸æ“‡å™¨ -->
<script type="module">
    // å°å…¥æ‰€éœ€æ¨¡çµ„
    import { loadWeeklyData } from '{% static "js/charts/charts.js" %}';
    import { setupChartDefaults } from '{% static "js/charts/config.js" %}';
    import { handleError } from '{% static "js/utils.js" %}';

    // ç­‰å¾… Chart.js è¼‰å…¥
    async function waitForChart() {
        if (typeof Chart !== 'undefined') return;

        return new Promise((resolve) => {
            const checkChart = () => {
                if (typeof Chart !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(checkChart, 50);
                }
            };
            checkChart();
        });
    }

    // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
    function showError(message) {
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = message;
        errorAlert.classList.remove('hidden');
    }

    // é¡¯ç¤º/éš±è—è¼‰å…¥å‹•ç•«
    function toggleLoading(show) {
        const chartLoading = document.getElementById('chartLoading');
        if (show) {
            chartLoading.classList.remove('hidden');
        } else {
            chartLoading.classList.add('hidden');
        }
    }

    // 3Dè§’è‰²åŠŸèƒ½å·²ç§»é™¤

    // Three.jsç›¸é—œä»£ç¢¼å·²ç§»é™¤

    // è§’è‰²ä½”ä½ç¬¦åŠŸèƒ½å·²ç§»é™¤

    async function initializeApp() {
        try {
            // ç­‰å¾… Chart.js
            await waitForChart();

            // è¨­ç½®åœ–è¡¨é è¨­å€¼
            setupChartDefaults();

            // åˆå§‹åŒ–æ¨‚å™¨é¸æ“‡å™¨
            const instrumentSelect = document.getElementById('id_instrument');
            const preferredInstrument = localStorage.getItem('preferredInstrument') || 'violin';
            instrumentSelect.value = preferredInstrument;
            
            // ç›£è½æ¨‚å™¨é¸æ“‡è®ŠåŒ–
            instrumentSelect.addEventListener('change', function() {
                const selectedInstrument = this.value;
                if (selectedInstrument) {
                    localStorage.setItem('preferredInstrument', selectedInstrument);
                    
                    // æ›´æ–°åœ–è¡¨
                    const studentName = document.getElementById('studentName').value;
                    if (studentName) {
                        loadWeeklyData(studentName, selectedInstrument);
                    }
                }
            });

            // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦æœ‰ç•¶å‰å­¸ç”Ÿ
            const currentStudent = window.INITIAL_STUDENT === "null" ? null : window.INITIAL_STUDENT;
            const savedStudent = localStorage.getItem('currentStudent');
            const studentToLoad = currentStudent || savedStudent;

            if (studentToLoad) {
                document.getElementById('studentName').value = studentToLoad;
                try {
                    toggleLoading(true);
                    await loadWeeklyData(studentToLoad);
                } catch (error) {
                    showError('è¼‰å…¥åœ–è¡¨æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                } finally {
                    toggleLoading(false);
                }
            }

            // è¡¨å–®æäº¤è™•ç†
            document.getElementById('practiceForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const form = this;
                const studentName = document.getElementById('studentName').value;

                try {
                    toggleLoading(true);
                    
                    // 3Dè§’è‰²å‹•ç•«å·²ç§»é™¤
                    
                    const formData = new FormData(form);
                    const data = {};
                    formData.forEach((value, key) => {
                        data[key] = value;
                    });

                    const response = await fetch('', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.CSRF_TOKEN,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.redirected) {
                        // å¦‚æœå¾Œç«¯è¿”å›é‡å®šå‘ï¼Œæˆ‘å€‘å°±è·Ÿéš¨é‡å®šå‘
                        window.location.href = response.url;
                        return;
                    }

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'æäº¤ç·´ç¿’è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤');
                    }

                    // ä¿å­˜ç•¶å‰å­¸ç”Ÿ
                    localStorage.setItem('currentStudent', studentName);

                    // é‡ç½®è¡¨å–®
                    form.reset();
                    document.getElementById('studentName').value = studentName;

                    // é‡æ–°è¼‰å…¥åœ–è¡¨
                    await loadWeeklyData(studentName);

                    // 3Dè§’è‰²æ…¶ç¥å‹•ç•«å·²ç§»é™¤

                    // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
                    const successAlert = document.createElement('div');
                    successAlert.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative mb-4';
                    successAlert.innerHTML = `
                        <i class="fas fa-check-circle mr-2"></i>
                        ç·´ç¿’è¨˜éŒ„å·²ä¿å­˜æˆåŠŸï¼
                        <button type="button" class="absolute top-0 right-0 px-4 py-3" onclick="this.parentElement.remove()">
                            <span class="text-2xl">&times;</span>
                        </button>
                    `;
                    form.insertAdjacentElement('beforebegin', successAlert);

                    // 3ç§’å¾Œè‡ªå‹•é—œé–‰æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        successAlert.remove();
                    }, 3000);

                } catch (error) {
                    // 3Dè§’è‰²éŒ¯èª¤å‹•ç•«å·²ç§»é™¤
                    showError(error.message);
                } finally {
                    toggleLoading(false);
                }
            });

        } catch (error) {
            console.error('åˆå§‹åŒ–å¤±æ•—:', error);
            showError('åˆå§‹åŒ–æ‡‰ç”¨æ™‚ç™¼ç”ŸéŒ¯èª¤');
        }
    }

    // å°èˆªåˆ°åˆ†æé é¢
    window.goToAnalytics = function () {
        const studentName = document.getElementById('studentName').value;
        if (studentName) {
            window.location.href = `/analytics/${encodeURIComponent(studentName)}/`;
        } else {
            showError('è«‹å…ˆè¼¸å…¥å­¸ç”Ÿå§“å');
        }
    };

    // å•Ÿå‹•æ‡‰ç”¨
    initializeApp().catch(error => {
        console.error('æ‡‰ç”¨å•Ÿå‹•å¤±æ•—:', error);
        showError('æ‡‰ç”¨å•Ÿå‹•å¤±æ•—');
    });

    // è¨­ç½®é»˜èªæ—¥æœŸç‚ºä»Šå¤©
    document.getElementById('practiceDate').value = new Date().toISOString().split('T')[0];
    
    // ç²¾ç·»è©•åˆ†ç³»çµ±
    const ratingSlider = document.getElementById('ratingSlider');
    const ratingInput = document.getElementById('rating');
    const ratingValue = document.getElementById('ratingValue');
    const ratingDesc = document.getElementById('ratingDesc');
    const sliderFill = document.getElementById('sliderFill');
    const pianoKeys = document.querySelectorAll('.piano-key');
    
    // è©•åˆ†æè¿°
    const ratingDescriptions = {
        1: 'éœ€è¦åŠ å¼·',
        2: 'å°šå¯',
        3: 'æ™®é€š',
        4: 'è‰¯å¥½',
        5: 'å„ªç§€'
    };
    
    // æ›´æ–°è©•åˆ†é¡¯ç¤º
    function updateRatingDisplay(rating) {
        // æ›´æ–°æ•¸å€¼å’Œæè¿°
        ratingValue.textContent = rating;
        ratingDesc.textContent = ratingDescriptions[rating];
        ratingInput.value = rating;
        
        // æ›´æ–°æ»‘æ¡¿å¡«å……
        const percentage = ((rating - 1) / 4) * 100;
        sliderFill.style.width = percentage + '%';
        
        // æ›´æ–°é‹¼ç´éµç›¤
        pianoKeys.forEach((key, index) => {
            key.classList.remove('bg-warm-brown', 'text-white');
            key.classList.add('bg-white');
            if (index < rating) {
                setTimeout(() => {
                    key.classList.remove('bg-white');
                    key.classList.add('bg-warm-brown', 'text-white', 'transform', 'translate-y-0.5');
                }, index * 50);
            }
        });
    }
    
    // æ»‘æ¡¿äº‹ä»¶
    ratingSlider.addEventListener('input', function() {
        updateRatingDisplay(parseInt(this.value));
    });
    
    // é‹¼ç´éµé»æ“Šäº‹ä»¶
    pianoKeys.forEach((key, index) => {
        key.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            ratingSlider.value = rating;
            updateRatingDisplay(rating);
        });
    });
    
    // åˆå§‹åŒ–é¡¯ç¤º
    updateRatingDisplay(3);

    // è¡¨å–®é©—è­‰å¢å¼·
    document.getElementById('practiceForm').addEventListener('submit', function(e) {
        const rating = document.getElementById('rating').value;
        if (!rating || rating < 1 || rating > 5) {
            e.preventDefault();
            showError('è«‹é¸æ“‡ç·´ç¿’è©•åˆ†ï¼ˆ1-5åˆ†ï¼‰');
            return false;
        }
        
        const minutes = document.getElementById('minutes').value;
        if (!minutes || minutes < 1 || minutes > 600) {
            e.preventDefault();
            showError('ç·´ç¿’æ™‚é–“å¿…é ˆåœ¨1-600åˆ†é˜ä¹‹é–“');
            return false;
        }
        
        return true;
    });

    // æ¨¡æ…‹æ¡†æ§åˆ¶å‡½æ•¸
    window.showLoginModal = function() {
        document.getElementById('loginModal').classList.remove('hidden');
    };

    window.showRegisterModal = function() {
        document.getElementById('registerModal').classList.remove('hidden');
    };

    window.switchToRegister = function() {
        document.getElementById('loginModal').classList.add('hidden');
        setTimeout(() => showRegisterModal(), 300);
    };

    window.switchToLogin = function() {
        document.getElementById('registerModal').classList.add('hidden');
        setTimeout(() => showLoginModal(), 300);
    };

    // è™•ç†ç™»å…¥è¡¨å–®æäº¤
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // ç²å–æ­£ç¢ºçš„ CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('{% url "practice_logs:login" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message || 'ç™»å…¥æˆåŠŸï¼');
                    location.reload();
                } else {
                    alert(data.message || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç”¨æˆ¶åå’Œå¯†ç¢¼');
                }
            })
            .catch(error => {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                alert('ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            });
        });
    }

    // è™•ç†è¨»å†Šè¡¨å–®æäº¤
    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
        registerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        // ç²å–æ­£ç¢ºçš„ CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('{% url "practice_logs:register" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(data.message || 'è¨»å†ŠæˆåŠŸï¼');
                location.reload();
            } else {
                alert(data.message || 'è¨»å†Šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¿¡æ¯æ˜¯å¦æ­£ç¢º');
            }
        })
        .catch(error => {
            console.error('è¨»å†ŠéŒ¯èª¤:', error);
            alert('è¨»å†Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
        });
        });
    }
</script>

<!-- ç™»å…¥æ¨¡æ…‹æ¡† -->
<div class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden" id="loginModal">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl shadow-2xl max-w-md w-full relative overflow-hidden">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-warm-brown via-light-brown to-warm-brown"></div>
            <div class="text-center pt-8 pb-4">
                <div class="text-5xl mb-4 animate-glow">ğŸ»</div>
                <h5 class="text-3xl font-serif text-gray-800 mb-2">æ­¡è¿å›ä¾†</h5>
                <button type="button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700" onclick="document.getElementById('loginModal').classList.add('hidden')">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-8 pt-0">
                <form id="loginForm" method="post">
                    {% csrf_token %}
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ¶åæˆ–é›»å­éƒµä»¶</label>
                        <input type="text" name="username" class="form-input" required>
                    </div>
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç¢¼</label>
                        <input type="password" name="password" class="form-input" required>
                    </div>
                    <button type="submit" class="w-full btn-primary">ç™»å…¥</button>
                </form>
            </div>
            <div class="text-center pb-8">
                <div class="text-gray-600">
                    é‚„æ²’æœ‰å¸³æˆ¶ï¼Ÿ<a href="#" class="text-warm-brown font-semibold hover:underline" onclick="switchToRegister()">ç«‹å³è¨»å†Š</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è¨»å†Šæ¨¡æ…‹æ¡† -->
<div class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden" id="registerModal">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl shadow-2xl max-w-md w-full relative overflow-hidden">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-warm-brown via-light-brown to-warm-brown"></div>
            <div class="text-center pt-8 pb-4">
                <div class="text-5xl mb-4 animate-glow">ğŸ»</div>
                <h5 class="text-3xl font-serif text-gray-800 mb-2">åŠ å…¥æˆ‘å€‘</h5>
                <button type="button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700" onclick="document.getElementById('registerModal').classList.add('hidden')">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-8 pt-0">
                <form id="registerForm" method="post">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ¶å</label>
                        <input type="text" name="username" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é›»å­éƒµä»¶</label>
                        <input type="email" name="email" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¸­æ–‡å§“å</label>
                        <input type="text" name="chinese_name" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">è§’è‰²</label>
                        <select name="role" class="form-input" required>
                            <option value="student">å­¸ç”Ÿ</option>
                            <option value="teacher">æ•™å¸«</option>
                            <option value="parent">å®¶é•·</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç¢¼</label>
                        <input type="password" name="password1" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç¢ºèªå¯†ç¢¼</label>
                        <input type="password" name="password2" class="form-input" required>
                    </div>
                    <button type="submit" class="w-full btn-primary">è¨»å†Š</button>
                </form>
            </div>
            <div class="text-center pb-8">
                <div class="text-gray-600">
                    å·²æœ‰å¸³æˆ¶ï¼Ÿ<a href="#" class="text-warm-brown font-semibold hover:underline" onclick="switchToLogin()">ç«‹å³ç™»å…¥</a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}