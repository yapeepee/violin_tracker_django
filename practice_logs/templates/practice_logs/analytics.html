{% extends "practice_logs/base.html" %}
{% load static %}

{% block content %}
<style>
    /* ===== è®Šé‡å®šç¾© ===== */
    :root {
        /* é¡è‰²ç³»çµ± */
        --color-violin: #8B4513;
        /* ä¸»è‰²ï¼šæº«æš–çš„æ·±è¤è‰²ï¼Œåƒå°æç´ */
        --color-brass: #DAA520;
        /* æ¬¡è¦è‰²ï¼šé‡‘è‰²ï¼ŒåƒéŠ…ç®¡æ¨‚å™¨ */
        --color-curtain: #800020;
        /* å¼·èª¿è‰²ï¼šé…’ç´…è‰²ï¼Œåƒå¤©éµçµ¨èˆå°ç°¾å¹• */
        --color-score: #FFF8E7;
        /* èƒŒæ™¯è‰²ï¼šæº«æš–çš„ç±³è‰²ï¼Œåƒè€ç´è­œ */
        --color-piano: #2F1810;
        /* æ–‡å­—è‰²ï¼šæ·±æœ¨è‰²ï¼Œåƒå¤è‘£é‹¼ç´ */

        /* å­—é«”ç³»çµ± */
        --font-serif: "Baskerville", "Times New Roman", serif;
        --font-sans: "Optima", "Segoe UI", sans-serif;

        /* é–“è·ç³»çµ± */
        --spacing-xs: 0.5rem;
        --spacing-sm: 1rem;
        --spacing-md: 1.5rem;
        --spacing-lg: 2rem;

        /* é™°å½±ç³»çµ± */
        --shadow-sm: 0 2px 4px rgba(139, 69, 19, 0.1);
        --shadow-md: 0 4px 8px rgba(139, 69, 19, 0.15);
        --shadow-lg: 0 8px 16px rgba(139, 69, 19, 0.2);

        /* åœ“è§’ç³»çµ± */
        --radius-sm: 6px;
        --radius-md: 12px;
        --radius-lg: 25px;

        /* å‹•ç•«ç³»çµ± */
        --transition-fast: 0.2s ease;
        --transition-normal: 0.3s ease;
        --transition-slow: 0.5s ease;
    }

    /* ===== åŸºç¤æ¨£å¼ ===== */
    body {
        background-color: var(--color-score);
        font-family: var(--font-sans);
        color: var(--color-piano);
    }

    /* æ’ç‰ˆç³»çµ± */
    .text-serif {
        font-family: var(--font-serif);
    }

    .text-sans {
        font-family: var(--font-sans);
    }

    /* ===== çµ„ä»¶æ¨£å¼ ===== */
    /* æ¨™é¡Œçµ„ä»¶ */
    .page-title {
        position: relative;
        text-align: center;
        margin: var(--spacing-lg) 0;
        padding-bottom: var(--spacing-sm);
        font-size: 2.5rem;
        color: var(--color-violin);
        font-family: var(--font-serif);
    }

    .page-title::after {
        content: "â™ª â™« â™ª";
        display: block;
        font-size: 1.5rem;
        color: var(--color-brass);
        margin-top: var(--spacing-xs);
    }

    /* å¡ç‰‡çµ„ä»¶ */
    .card {
        border: none;
        border-radius: var(--radius-md);
        background: linear-gradient(135deg, #fff 0%, var(--color-score) 100%);
        box-shadow: var(--shadow-md);
        transition: transform var(--transition-normal),
            box-shadow var(--transition-normal);
        border-top: 3px solid var(--color-violin);
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .card-body {
        padding: var(--spacing-lg);
    }

    .card-title {
        font-family: var(--font-serif);
        color: var(--color-violin);
        font-size: 1.3rem;
        margin-bottom: var(--spacing-md);
        padding-bottom: var(--spacing-xs);
        border-bottom: 2px solid var(--color-brass);
        position: relative;
    }

    .card-title::before {
        content: "â™ª";
        position: absolute;
        left: -1.5rem;
        color: var(--color-brass);
        font-size: 1.2rem;
    }

    /* çµ±è¨ˆå¡ç‰‡ */
    .stat-card {
        text-align: center;
        padding: var(--spacing-md);
        background: linear-gradient(135deg, #fff 0%, var(--color-score) 100%);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: "â™«";
        position: absolute;
        top: -1rem;
        right: -1rem;
        font-size: 4rem;
        color: rgba(139, 69, 19, 0.1);
        transform: rotate(15deg);
    }

    .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--color-violin);
        margin: var(--spacing-xs) 0;
        font-family: var(--font-serif);
    }

    .stat-label {
        color: var(--color-piano);
        font-size: 1rem;
        font-family: var(--font-serif);
        position: relative;
        display: inline-block;
    }

    .stat-label::after {
        content: "";
        display: block;
        width: 50%;
        height: 2px;
        background: var(--color-brass);
        margin: var(--spacing-xs) auto;
    }

    /* æŒ‰éˆ•çµ„ä»¶ */
    .btn {
        border-radius: var(--radius-lg);
        padding: var(--spacing-xs) var(--spacing-md);
        font-family: var(--font-serif);
        transition: all var(--transition-normal);
    }

    /* é¦–é æŒ‰éˆ• */
    .home-button {
        position: relative;
        font-family: var(--font-serif);
        color: var(--color-violin);
        border: 2px solid var(--color-violin);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xs) var(--spacing-md);
        transition: all var(--transition-normal);
        background: linear-gradient(to right, var(--color-violin) 50%, transparent 50%);
        background-size: 200% 100%;
        background-position: right bottom;
        text-decoration: none;
    }

    .home-button:hover {
        background-position: left bottom;
        color: var(--color-score);
    }

    .home-button i {
        margin-right: var(--spacing-xs);
        transition: transform var(--transition-normal);
    }

    .home-button:hover i {
        transform: translateX(-3px);
    }

    .home-button::after {
        content: "â™ª";
        position: absolute;
        right: -10px;
        top: -10px;
        font-size: 1.2rem;
        color: var(--color-brass);
        opacity: 0;
        transition: all var(--transition-normal);
    }

    .home-button:hover::after {
        opacity: 1;
        transform: rotate(15deg);
    }

    /* è¡¨å–®çµ„ä»¶ */
    .date-range-form {
        background-color: #fff;
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        border-top: 3px solid var(--color-brass);
    }

    .form-control {
        border-radius: var(--radius-lg);
        border: 2px solid var(--color-brass);
        padding: var(--spacing-xs) var(--spacing-sm);
        font-family: var(--font-sans);
        background-color: var(--color-score);
    }

    .form-control:focus {
        border-color: var(--color-violin);
        box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.2);
    }

    /* åœ–è¡¨å®¹å™¨ */
    .chart-container {
        position: relative;
        height: 300px;
        margin: var(--spacing-sm) 0;
        padding: var(--spacing-sm);
        background: rgba(255, 255, 255, 0.7);
        border-radius: var(--radius-sm);
    }

    /* é€²åº¦æ¢ */
    .progress {
        height: 12px;
        border-radius: var(--radius-sm);
        background-color: var(--color-score);
        overflow: hidden;
    }

    .progress-bar {
        background-color: var(--color-brass);
        transition: width 0.6s ease;
    }

    /* è£é£¾å…ƒç´  */
    .decoration {
        position: fixed;
        opacity: 0.1;
        pointer-events: none;
        z-index: -1;
    }

    .decoration-1 {
        top: 10%;
        left: 5%;
        font-size: 5rem;
        transform: rotate(-15deg);
    }

    .decoration-2 {
        bottom: 10%;
        right: 5%;
        font-size: 6rem;
        transform: rotate(15deg);
    }

    .hover-shadow {
        transition: all 0.3s ease;
    }

    .hover-shadow:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }

    .piece-selector-wrapper {
        position: relative;
        min-width: 200px;
    }

    .custom-select {
        background-color: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 20px;
        padding: 0.375rem 2rem 0.375rem 1rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .custom-select:hover {
        border-color: #007bff;
        background-color: #fff;
    }

    .custom-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        background-color: #fff;
    }

    .stats-info {
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
    }

    .stats-info.show {
        opacity: 1;
        transform: translateY(0);
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }

        100% {
            transform: scale(1);
        }
    }

    .highlight-piece {
        animation: pulse 0.5s ease-in-out;
    }

    /* è‡ªå®šç¾©ä¸‹æ‹‰é¸å–®ä¸­çš„åœ–ç‰‡é¡¯ç¤º */
    #pieceSelector option {
        padding: 8px;
        display: flex;
        align-items: center;
    }

    /* ç¢ºä¿ä¸‹æ‹‰é¸å–®ä¸­çš„åœ–ç‰‡æ­£ç¢ºé¡¯ç¤º */
    #pieceSelector {
        padding-left: 30px;
        /* ç‚ºåœ–ç‰‡ç•™å‡ºç©ºé–“ */
    }

    .piece-selector-wrapper::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        background-size: cover;
        border-radius: 50%;
        z-index: 1;
    }

    /* ç•¶é¸æ“‡å™¨æ‰“é–‹æ™‚çš„æ¨£å¼ */
    #pieceSelector:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    /* è‡ªå®šç¾©ä¸‹æ‹‰é¸å–®æ¨£å¼ */
    .piece-selector-wrapper select {
        background-color: white;
        border: 1px solid #ced4da;
        border-radius: 20px;
        padding: 8px 12px 8px 40px;
        /* å·¦å´ç•™æ›´å¤šç©ºé–“çµ¦åœ–ç‰‡ */
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        min-width: 200px;
    }

    /* æ”¹é€²é¸é …æ¨£å¼ */
    .piece-selector-wrapper select option {
        padding: 8px;
        display: flex;
        align-items: center;
    }

    /* åœ–ç‰‡æ¨£å¼ */
    .composer-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 8px;
        object-fit: cover;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        background-color: #f8f9fa;
    }

    /* é¸æ“‡å™¨æ‡¸æµ®æ•ˆæœ */
    .piece-selector-wrapper select:hover {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1);
    }

    /* é¸æ“‡å™¨ç„¦é»æ•ˆæœ */
    .piece-selector-wrapper select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
    }

    /* ç¢ºä¿ä¸‹æ‹‰é¸å–®ä¸­çš„å…§å®¹æ­£ç¢ºå°é½Š */
    .piece-selector-wrapper select option div {
        display: flex !important;
        align-items: center !important;
        padding: 4px 8px;
    }

    /* æ·»åŠ é¸é …æ‡¸æµ®æ•ˆæœ */
    .piece-selector-wrapper select option:hover {
        background-color: #f8f9fa;
    }

    /* ç•¶å‰é¸ä¸­é …çš„æ¨£å¼ */
    .piece-selector-wrapper select option:checked {
        background-color: #007bff;
        color: white;
    }
</style>

<!-- è£é£¾éŸ³ç¬¦ -->
<div class="decoration decoration-1">â™ª</div>
<div class="decoration decoration-2">â™«</div>

<div class="container mt-4">
    <!-- é é¢æ¨™é¡Œå€ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="/" class="home-button">
            <i class="fas fa-arrow-left"></i> è¿”å›é¦–é 
        </a>
    </div>

    <h1 class="page-title">{{ student_name }}çš„ç·´ç¿’åˆ†æ</h1>

    {% if error %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- æ—¥æœŸé¸æ“‡å€ -->
    <div class="date-range-form mb-4">
        <form id="dateRangeForm" class="d-flex align-items-center flex-wrap justify-content-center">
            <div class="btn-group me-3 mb-2 mb-md-0">
                <button type="button" class="btn btn-outline-secondary" data-days="7">æœ€è¿‘ä¸€é€±</button>
                <button type="button" class="btn btn-outline-secondary" data-days="30">æœ€è¿‘ä¸€æœˆ</button>
                <button type="button" class="btn btn-outline-secondary" data-days="90">æœ€è¿‘ä¸‰æœˆ</button>
                <button type="button" class="btn btn-outline-secondary" data-days="180">æœ€è¿‘åŠå¹´</button>
            </div>
            <div class="d-flex align-items-center flex-wrap">
                <input type="date" id="startDate" class="form-control me-2 mb-2 mb-md-0" style="width: 150px;">
                <span class="me-2 mb-2 mb-md-0">è‡³</span>
                <input type="date" id="endDate" class="form-control me-2 mb-2 mb-md-0" style="width: 150px;">
                <button type="submit" class="btn btn-outline-primary mb-2 mb-md-0">æ›´æ–°</button>
            </div>
        </form>
    </div>

    <!-- åŸºæœ¬çµ±è¨ˆå€ -->
    <div class="row g-4 mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="card stat-card">
                <div class="stat-label">ç¸½ç·´ç¿’æ™‚é–“</div>
                <div class="stat-value">{{ stats.total_practice_time|default:0 }}<small class="ms-1">åˆ†é˜</small></div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card stat-card">
                <div class="stat-label">ç·´ç¿’æ¬¡æ•¸</div>
                <div class="stat-value">{{ stats.total_sessions|default:0 }}<small class="ms-1">æ¬¡</small></div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card stat-card">
                <div class="stat-label">å¹³å‡è©•åˆ†</div>
                <div class="stat-value">{{ stats.avg_rating|floatformat:1 }}</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card stat-card">
                <div class="stat-label">å¹³å‡æ¯æ¬¡æ™‚é•·</div>
                <div class="stat-value">{{ stats.avg_session_length|floatformat:0 }}<small class="ms-1">åˆ†é˜</small></div>
            </div>
        </div>
    </div>

    <!-- åœ–è¡¨å€ -->
    <div class="row g-4">
        <!-- æ¯é€±ç·´ç¿’ç¸½æ™‚æ•¸ -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">æ¯é€±ç·´ç¿’ç¸½æ™‚æ•¸</h5>
                    <div class="chart-container">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨‚æ›²ç·´ç¿’æ™‚é–“åˆ†å¸ƒ -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">æ¨‚æ›²ç·´ç¿’æ™‚é–“åˆ†å¸ƒ</h5>
                    <div class="chart-container position-relative">
                        <canvas id="pieceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘ç·´ç¿’è¶¨å‹¢ -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">æœ€è¿‘ç·´ç¿’è¶¨å‹¢</h5>
                    <div class="chart-container">
                        <canvas id="recentTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç·´ç¿’é‡é»åˆ†æ -->
        <div class="col-md-6">
            <div class="card h-100 shadow-sm hover-shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0 d-flex align-items-center">
                            <i class="fas fa-bullseye me-2 text-primary"></i>
                            ç·´ç¿’é‡é»åˆ†æ
                        </h5>
                        <div class="piece-selector-wrapper">
                            <select id="pieceSelector" class="form-select form-select-sm custom-select">
                                <option value="">ğŸµ æ•´é«”åˆ†æ</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container position-relative">
                        <canvas id="focusChart"></canvas>
                    </div>
                    <div id="focusStatsInfo" class="mt-3 text-center stats-info d-none">
                        <!-- çµ±è¨ˆä¿¡æ¯å°‡ç”± JavaScript å‹•æ…‹æ·»åŠ  -->
                    </div>
                </div>
            </div>
        </div>

        <!-- æ›²ç›®æˆæ•ˆæ¯”è¼ƒ -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">æ›²ç›®æˆæ•ˆæ¯”è¼ƒ</h5>
                    <div class="chart-container">
                        <canvas id="pieceEffectivenessChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ™‚é–“æ•ˆæœåˆ†æ -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">æ™‚é–“æ•ˆæœåˆ†æ</h5>
                    <div class="chart-container position-relative">
                        <canvas id="timeEffectChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
    // ç­‰å¾… Chart.js è¼‰å…¥
    async function waitForChart() {
        if (typeof Chart !== 'undefined') return;

        return new Promise((resolve) => {
            const checkChart = () => {
                if (typeof Chart !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(checkChart, 50);
                }
            };
            checkChart();
        });
    }

    async function initializeApp() {
        try {
            // ç­‰å¾… Chart.js
            await waitForChart();

            // è¼‰å…¥æ¨¡çµ„
            const [chartsModule, configModule, utilsModule] = await Promise.all([
                import('{% static "js/charts/charts.js" %}'),
                import('{% static "js/charts/config.js" %}'),
                import('{% static "js/utils.js" %}')
            ]);

            const {
                loadWeeklyData,
                loadPieceData,
                loadRecentTrendData,
                loadFocusStats,
                loadPieceEffectivenessData,
                loadTimeEffectAnalysis
            } = chartsModule;
            const { setupChartDefaults } = configModule;
            const { formatDate, handleError } = utilsModule;

            const studentName = '{{ student_name|escapejs }}';

            // è¨­ç½®åœ–è¡¨é è¨­å€¼
            setupChartDefaults();

            // è¼‰å…¥æ‰€æœ‰åœ–è¡¨
            function initAnalyticsCharts() {
                if (!studentName || studentName.trim() === '') {
                    console.warn('æœªæä¾›å­¸ç”Ÿå§“å');
                    return;
                }

                console.log(`é–‹å§‹è¼‰å…¥ ${studentName} çš„åœ–è¡¨`);

                loadWeeklyData(studentName);
                loadPieceData(studentName);
                loadRecentTrendData(studentName);
                loadFocusStats(studentName);
                loadPieceEffectivenessData(studentName);
                loadTimeEffectAnalysis(studentName);
            }

            // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initAnalyticsCharts);
            } else {
                initAnalyticsCharts();
            }

        } catch (error) {
            console.error('åˆå§‹åŒ–å¤±æ•—:', error);
        }
    }

    // å•Ÿå‹•æ‡‰ç”¨
    initializeApp();
</script>
{% endblock %}