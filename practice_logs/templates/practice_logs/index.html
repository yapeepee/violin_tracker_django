{% extends "practice_logs/base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <h1>🎻 小提琴練琴日誌</h1>
    <form method='POST' id="practiceForm">
        {% csrf_token %}
        <div class="form-group" data-label="學生姓名">
            <input type="text" name="student_name" id="studentName" placeholder="請輸入學生姓名" required
                value="{{ current_student|default:'' }}">
        </div>
        <div class="form-group" data-label="曲目名稱">
            <input type="text" name="piece" placeholder="請輸入練習曲目" required>
        </div>
        <div class="form-group" data-label="練習時間">
            <input type="number" name="minutes" placeholder="請輸入練習時間（分鐘）" min="1" required>
        </div>
        <div class="form-group" data-label="練習評分">
            <select name="rating" required>
                <option value="" disabled selected>請選擇今日練習評分</option>
                {% for i in "12345" %}
                <option value="{{ i }}">{{ i }} 星 ⭐</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit">記錄練習 ✨</button>
    </form>

    <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>🎵 練習時間統計</h2>
            <div id="analyticsLink">
                <a href="#" class="btn btn-primary" onclick="goToAnalytics()">
                    查看詳細分析 📊
                </a>
            </div>
        </div>
        <div id="studentInfo" class="student-info" style="text-align: center; margin-bottom: 1rem;"></div>
        <div class="chart-wrapper">
            <canvas id="weeklyChart"></canvas>
        </div>
    </div>
</div>

<!-- 將 Django 變量傳遞給 JavaScript -->
<script>
    window.INITIAL_STUDENT = "{{ current_student|default:'null' }}";
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
    import { loadWeeklyData } from '{% static "js/charts/charts.js" %}';
    import { setupChartDefaults } from '{% static "js/charts/config.js" %}';

    function goToAnalytics() {
        const studentName = document.getElementById('studentName').value;
        if (studentName) {
            window.location.href = `/analytics/${encodeURIComponent(studentName)}/`;
        } else {
            alert('請先輸入學生姓名');
        }
    }
    window.goToAnalytics = goToAnalytics;

    // 當表單提交時更新圖表
    document.getElementById('practiceForm').addEventListener('submit', function () {
        const studentName = document.getElementById('studentName').value;
        localStorage.setItem('currentStudent', studentName);
    });

    // 頁面載入時檢查是否有當前學生
    document.addEventListener('DOMContentLoaded', function () {
        setupChartDefaults();
        const currentStudent = window.INITIAL_STUDENT === "null" ? null : window.INITIAL_STUDENT;
        const savedStudent = localStorage.getItem('currentStudent');
        const studentToLoad = currentStudent || savedStudent;

        if (studentToLoad) {
            document.getElementById('studentName').value = studentToLoad;
            loadWeeklyData(studentToLoad);
        }
    });
</script>
{% endblock %}