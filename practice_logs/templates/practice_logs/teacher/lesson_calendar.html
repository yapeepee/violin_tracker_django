{% extends 'practice_logs/teacher/base_teacher.html' %}
{% load static %}

{% block title %}èª²ç¨‹æ—¥æ›† - æ•™å¸«ç³»çµ±{% endblock %}

{% block extra_css %}
<style>
/* æ—¥æ›†å®¹å™¨ */
.calendar-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

/* é é¢æ¨™é¡Œå€ */
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.calendar-title {
    font-size: 2rem;
    color: #333;
}

.calendar-actions {
    display: flex;
    gap: 15px;
}

.btn-create {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 24px;
    background: #2c5f3d;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
}

.btn-create:hover {
    background: #245030;
    transform: translateY(-2px);
}

/* æ—¥æ›†å°èˆª */
.calendar-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
}

.nav-btn {
    padding: 8px 16px;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.nav-btn:hover {
    border-color: #2c5f3d;
    color: #2c5f3d;
}

.current-month {
    font-size: 1.3rem;
    font-weight: 600;
    color: #333;
}

/* ä¸»è¦ä½ˆå±€ */
.calendar-main {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 30px;
}

/* æ—¥æ›†ç¶²æ ¼ */
.calendar-grid {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.weekday-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}

.weekday {
    text-align: center;
    font-weight: 600;
    color: #666;
    padding: 10px;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
}

.calendar-day {
    min-height: 100px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 8px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
}

.calendar-day:hover {
    border-color: #2c5f3d;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.calendar-day.today {
    background: #e8f5e9;
    border-color: #2c5f3d;
}

.calendar-day.other-month {
    opacity: 0.4;
}

.calendar-day.has-lessons {
    background: #f5f5f5;
}

.day-number {
    font-weight: 600;
    margin-bottom: 5px;
}

.day-lessons {
    font-size: 0.85rem;
}

.lesson-item {
    padding: 3px 6px;
    margin: 2px 0;
    border-radius: 5px;
    background: #2c5f3d;
    color: white;
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.lesson-item.completed {
    background: #4caf50;
}

.lesson-item.cancelled {
    background: #f44336;
}

/* å´é‚Šæ¬„ */
.calendar-sidebar {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.sidebar-section {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.section-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: #333;
}

/* ä»Šæ—¥èª²ç¨‹ */
.today-lesson {
    padding: 15px;
    border-radius: 10px;
    background: #f8f9fa;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.today-lesson:hover {
    background: #e8f5e9;
}

.lesson-time {
    font-weight: 600;
    color: #2c5f3d;
    margin-bottom: 5px;
}

.lesson-student {
    font-weight: 500;
    margin-bottom: 5px;
}

.lesson-info {
    font-size: 0.9rem;
    color: #666;
}

/* çµ±è¨ˆå¡ç‰‡ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.stat-card {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2c5f3d;
}

.stat-label {
    font-size: 0.85rem;
    color: #666;
}

/* å¾…è™•ç†èª²ç¨‹ */
.pending-lesson {
    padding: 12px;
    border-left: 4px solid #ff9800;
    background: #fff8e1;
    border-radius: 5px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.pending-lesson:hover {
    background: #ffecb3;
}

/* ç©ºç‹€æ…‹ */
.empty-state {
    text-align: center;
    padding: 40px;
    color: #666;
}

.empty-icon {
    font-size: 3rem;
    color: #ddd;
    margin-bottom: 15px;
}

/* æ¨¡æ…‹æ¡† - æ—¥æœŸè©³æƒ… */
.day-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
}

.modal-content {
    background: white;
    margin: 10% auto;
    padding: 30px;
    width: 90%;
    max-width: 600px;
    border-radius: 20px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-title {
    font-size: 1.5rem;
    color: #333;
}

.close-modal {
    font-size: 1.5rem;
    cursor: pointer;
    color: #999;
}

.close-modal:hover {
    color: #333;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 1024px) {
    .calendar-main {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .calendar-header {
        flex-direction: column;
        gap: 20px;
    }
    
    .calendar-actions {
        width: 100%;
        justify-content: center;
    }
    
    .calendar-day {
        min-height: 80px;
        font-size: 0.9rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="calendar-header">
        <h1 class="calendar-title">ğŸ“… èª²ç¨‹æ—¥æ›†</h1>
        <div class="calendar-actions">
            <a href="{% url 'practice_logs:create_lesson' %}?date={{ selected_date|date:'Y-m-d' }}" class="btn-create">
                <i class="fas fa-plus"></i> æ–°å¢èª²ç¨‹
            </a>
            <a href="{% url 'practice_logs:batch_create_lessons' %}" class="btn-create" style="background: #1976d2;">
                <i class="fas fa-calendar-plus"></i> æ‰¹æ¬¡æ’èª²
            </a>
            <a href="{% url 'practice_logs:lesson_list' %}" class="btn-create" style="background: #7b1fa2;">
                <i class="fas fa-list"></i> èª²ç¨‹åˆ—è¡¨
            </a>
        </div>
    </div>
    
    <!-- æ—¥æ›†å°èˆª -->
    <div class="calendar-nav">
        <button class="nav-btn" onclick="changeMonth(-1)">
            <i class="fas fa-chevron-left"></i>
        </button>
        <h2 class="current-month">{{ selected_date|date:"Yå¹´ F" }}</h2>
        <button class="nav-btn" onclick="changeMonth(1)">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    
    <div class="calendar-main">
        <!-- æ—¥æ›†ç¶²æ ¼ -->
        <div class="calendar-grid">
            <div class="weekday-header">
                <div class="weekday">æ—¥</div>
                <div class="weekday">ä¸€</div>
                <div class="weekday">äºŒ</div>
                <div class="weekday">ä¸‰</div>
                <div class="weekday">å››</div>
                <div class="weekday">äº”</div>
                <div class="weekday">å…­</div>
            </div>
            
            <div class="calendar-days" id="calendarDays">
                <!-- æ—¥æ›†å¤©æ•¸å°‡ç”±JavaScriptç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- å´é‚Šæ¬„ -->
        <div class="calendar-sidebar">
            <!-- ä»Šæ—¥èª²ç¨‹ -->
            <div class="sidebar-section">
                <h3 class="section-title">
                    <i class="fas fa-calendar-day"></i> ä»Šæ—¥èª²ç¨‹
                </h3>
                {% if today_lessons %}
                    {% for lesson in today_lessons %}
                    <div class="today-lesson" onclick="location.href='{% url 'practice_logs:lesson_detail' lesson.id %}'">
                        <div class="lesson-time">{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</div>
                        <div class="lesson-student">{{ lesson.student.profile.display_name|default:lesson.student.username }}</div>
                        <div class="lesson-info">
                            <span class="badge" style="background: {% if lesson.status == 'completed' %}#4caf50{% elif lesson.status == 'cancelled' %}#f44336{% else %}#2196f3{% endif %};">
                                {{ lesson.get_status_display }}
                            </span>
                            {{ lesson.topic|truncatechars:30 }}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <p>ä»Šå¤©æ²’æœ‰æ’å®šçš„èª²ç¨‹</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- æœ¬é€±çµ±è¨ˆ -->
            <div class="sidebar-section">
                <h3 class="section-title">
                    <i class="fas fa-chart-bar"></i> æœ¬é€±çµ±è¨ˆ
                </h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ week_stats.total_lessons|default:0 }}</div>
                        <div class="stat-label">ç¸½èª²ç¨‹æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ week_stats.completed_lessons|default:0 }}</div>
                        <div class="stat-label">å·²å®Œæˆ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ week_stats.cancelled_lessons|default:0 }}</div>
                        <div class="stat-label">å·²å–æ¶ˆ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">
                            {% if week_stats.total_lessons > 0 %}
                                {{ week_stats.completed_lessons|default:0|floatformat:0 }}%
                            {% else %}
                                0%
                            {% endif %}
                        </div>
                        <div class="stat-label">å®Œæˆç‡</div>
                    </div>
                </div>
            </div>
            
            <!-- å¾…è™•ç†èª²ç¨‹ -->
            {% if pending_lessons %}
            <div class="sidebar-section">
                <h3 class="section-title">
                    <i class="fas fa-exclamation-circle"></i> å¾…å®Œæˆèª²ç¨‹
                </h3>
                {% for lesson in pending_lessons|slice:":5" %}
                <div class="pending-lesson" onclick="location.href='{% url 'practice_logs:lesson_detail' lesson.id %}'">
                    <div style="font-weight: 600;">
                        {{ lesson.lesson_date|date:"m/d" }} - {{ lesson.student.profile.display_name|default:lesson.student.username }}
                    </div>
                    <div style="font-size: 0.9rem; color: #666;">
                        {{ lesson.start_time|time:"H:i" }} | {{ lesson.get_lesson_type_display }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- æ—¥æœŸè©³æƒ…æ¨¡æ…‹æ¡† -->
<div id="dayModal" class="day-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalDate"></h2>
            <span class="close-modal" onclick="closeDayModal()">&times;</span>
        </div>
        <div id="modalLessons">
            <!-- èª²ç¨‹è©³æƒ…å°‡åœ¨é€™è£¡é¡¯ç¤º -->
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button type="button" id="createLessonBtn" class="btn-create" onclick="openCreateLessonModal()">
                <i class="fas fa-plus"></i> åœ¨æ­¤æ—¥æœŸæ–°å¢èª²ç¨‹
            </button>
        </div>
    </div>
</div>

<!-- æ–°å¢èª²ç¨‹æ¨¡æ…‹æ¡† -->
<div id="createLessonModal" class="day-modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-plus-circle"></i> æ–°å¢èª²ç¨‹
            </h2>
            <span class="close-modal" onclick="closeCreateLessonModal()">&times;</span>
        </div>
        
        <form id="quickCreateLessonForm">
            {% csrf_token %}
            <input type="hidden" name="lesson_date" id="modalLessonDate">
            
            <div style="display: grid; gap: 20px;">
                <!-- å­¸ç”Ÿé¸æ“‡ -->
                <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                        é¸æ“‡å­¸ç”Ÿ <span style="color: #d32f2f;">*</span>
                    </label>
                    <select name="student" class="form-control" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="">è«‹é¸æ“‡å­¸ç”Ÿ</option>
                        {% for student in students %}
                        <option value="{{ student.id }}">
                            {{ student.profile.display_name|default:student.username }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- æ™‚é–“è¨­å®š -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            é–‹å§‹æ™‚é–“ <span style="color: #d32f2f;">*</span>
                        </label>
                        <input type="time" name="start_time" class="form-control" value="14:00" required 
                               style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <div>
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                            èª²ç¨‹æ™‚é•·
                        </label>
                        <select name="duration_minutes" class="form-control" 
                                style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <option value="30">30åˆ†é˜</option>
                            <option value="45">45åˆ†é˜</option>
                            <option value="60" selected>60åˆ†é˜</option>
                            <option value="90">90åˆ†é˜</option>
                        </select>
                    </div>
                </div>
                
                <!-- èª²ç¨‹ä¸»é¡Œ -->
                <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                        èª²ç¨‹ä¸»é¡Œ
                    </label>
                    <input type="text" name="topic" class="form-control" placeholder="ä¾‹å¦‚ï¼šå·´å“ˆå°æ­¥èˆæ›²ç·´ç¿’"
                           style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                </div>
                
                <!-- èª²ç¨‹é¡å‹ -->
                <div>
                    <label style="font-weight: 600; margin-bottom: 8px; display: block;">
                        èª²ç¨‹é¡å‹
                    </label>
                    <select name="lesson_type" class="form-control"
                            style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="regular">å¸¸è¦èª²ç¨‹</option>
                        <option value="makeup">è£œèª²</option>
                        <option value="exam_prep">è€ƒè©¦æº–å‚™</option>
                        <option value="masterclass">å¤§å¸«ç­</option>
                        <option value="online">ç·šä¸Šèª²ç¨‹</option>
                    </select>
                </div>
                
                <!-- æŒ‰éˆ• -->
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateLessonModal()">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> å‰µå»ºèª²ç¨‹
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// å…¨å±€è®Šé‡
const selectedDate = new Date('{{ selected_date|date:"Y-m-d" }}');
const lessonsByDate = {{ lessons_by_date|safe }};
const today = new Date();
let currentModalDate = null;

// åˆå§‹åŒ–æ—¥æ›†
document.addEventListener('DOMContentLoaded', function() {
    renderCalendar();
});

// æ¸²æŸ“æ—¥æ›†
function renderCalendar() {
    const year = selectedDate.getFullYear();
    const month = selectedDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const prevLastDay = new Date(year, month, 0);
    
    const firstDayOfWeek = firstDay.getDay();
    const lastDateOfMonth = lastDay.getDate();
    const lastDateOfPrevMonth = prevLastDay.getDate();
    
    const calendarDays = document.getElementById('calendarDays');
    calendarDays.innerHTML = '';
    
    // ä¸Šå€‹æœˆçš„æ—¥æœŸ
    for (let i = firstDayOfWeek; i > 0; i--) {
        const day = lastDateOfPrevMonth - i + 1;
        const dateStr = formatDate(new Date(year, month - 1, day));
        createDayElement(day, dateStr, true);
    }
    
    // ç•¶æœˆçš„æ—¥æœŸ
    for (let day = 1; day <= lastDateOfMonth; day++) {
        const dateStr = formatDate(new Date(year, month, day));
        createDayElement(day, dateStr, false);
    }
    
    // ä¸‹å€‹æœˆçš„æ—¥æœŸ
    const remainingDays = 42 - (firstDayOfWeek + lastDateOfMonth);
    for (let day = 1; day <= remainingDays; day++) {
        const dateStr = formatDate(new Date(year, month + 1, day));
        createDayElement(day, dateStr, true);
    }
}

// å‰µå»ºæ—¥æœŸå…ƒç´ 
function createDayElement(day, dateStr, otherMonth) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©
    if (!otherMonth && dateStr === formatDate(today)) {
        dayElement.classList.add('today');
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºå…¶ä»–æœˆä»½
    if (otherMonth) {
        dayElement.classList.add('other-month');
    }
    
    // æª¢æŸ¥æ˜¯å¦æœ‰èª²ç¨‹
    const lessons = lessonsByDate[dateStr] || [];
    if (lessons.length > 0) {
        dayElement.classList.add('has-lessons');
    }
    
    // æ—¥æœŸæ•¸å­—
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = day;
    dayElement.appendChild(dayNumber);
    
    // èª²ç¨‹åˆ—è¡¨
    if (lessons.length > 0) {
        const lessonsDiv = document.createElement('div');
        lessonsDiv.className = 'day-lessons';
        
        lessons.slice(0, 3).forEach(lesson => {
            const lessonItem = document.createElement('div');
            lessonItem.className = 'lesson-item ' + lesson.status;
            lessonItem.textContent = `${lesson.start_time.substring(0, 5)} ${lesson.student__profile__display_name || lesson.student__username}`;
            lessonsDiv.appendChild(lessonItem);
        });
        
        if (lessons.length > 3) {
            const moreItem = document.createElement('div');
            moreItem.className = 'lesson-item';
            moreItem.style.background = '#666';
            moreItem.textContent = `+${lessons.length - 3} æ›´å¤š`;
            lessonsDiv.appendChild(moreItem);
        }
        
        dayElement.appendChild(lessonsDiv);
    }
    
    // é»æ“Šäº‹ä»¶
    dayElement.onclick = () => showDayDetails(dateStr, lessons);
    
    document.getElementById('calendarDays').appendChild(dayElement);
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// é¡¯ç¤ºæ—¥æœŸè©³æƒ…
function showDayDetails(dateStr, lessons) {
    const modal = document.getElementById('dayModal');
    const modalDate = document.getElementById('modalDate');
    const modalLessons = document.getElementById('modalLessons');
    
    // å„²å­˜ç•¶å‰æ—¥æœŸä¾›æ–°å¢èª²ç¨‹ä½¿ç”¨
    currentModalDate = dateStr;
    
    // è¨­ç½®æ—¥æœŸæ¨™é¡Œ
    const date = new Date(dateStr);
    modalDate.textContent = date.toLocaleDateString('zh-TW', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        weekday: 'long'
    });
    
    // é¡¯ç¤ºèª²ç¨‹åˆ—è¡¨
    if (lessons.length > 0) {
        let html = '<h3>ç•¶æ—¥èª²ç¨‹</h3>';
        lessons.forEach(lesson => {
            html += `
                <div class="today-lesson" style="margin-bottom: 10px;">
                    <div class="lesson-time">${lesson.start_time} - ${lesson.end_time || 'æœªçŸ¥'}</div>
                    <div class="lesson-student">${lesson.student__profile__display_name || lesson.student__username}</div>
                    <div class="lesson-info">
                        <span class="badge" style="background: ${getStatusColor(lesson.status)};">
                            ${getStatusDisplay(lesson.status)}
                        </span>
                        ${lesson.topic || 'ç„¡ä¸»é¡Œ'}
                    </div>
                </div>
            `;
        });
        modalLessons.innerHTML = html;
    } else {
        modalLessons.innerHTML = '<p style="text-align: center; color: #666;">æ­¤æ—¥æœŸæ²’æœ‰æ’å®šçš„èª²ç¨‹</p>';
    }
    
    modal.style.display = 'block';
}

// é—œé–‰æ¨¡æ…‹æ¡†
function closeDayModal() {
    document.getElementById('dayModal').style.display = 'none';
}

// é–‹å•Ÿæ–°å¢èª²ç¨‹æ¨¡æ…‹æ¡†
function openCreateLessonModal() {
    // å…ˆé—œé–‰æ—¥æœŸè©³æƒ…æ¨¡æ…‹æ¡†
    closeDayModal();
    
    // è¨­ç½®æ—¥æœŸ
    document.getElementById('modalLessonDate').value = currentModalDate;
    
    // é¡¯ç¤ºæ–°å¢èª²ç¨‹æ¨¡æ…‹æ¡†
    document.getElementById('createLessonModal').style.display = 'block';
}

// é—œé–‰æ–°å¢èª²ç¨‹æ¨¡æ…‹æ¡†
function closeCreateLessonModal() {
    document.getElementById('createLessonModal').style.display = 'none';
    document.getElementById('quickCreateLessonForm').reset();
}

// åˆ‡æ›æœˆä»½
function changeMonth(direction) {
    const newDate = new Date(selectedDate);
    newDate.setMonth(newDate.getMonth() + direction);
    
    const year = newDate.getFullYear();
    const month = String(newDate.getMonth() + 1).padStart(2, '0');
    const day = String(newDate.getDate()).padStart(2, '0');
    
    window.location.href = `?date=${year}-${month}-${day}`;
}

// ç²å–ç‹€æ…‹é¡è‰²
function getStatusColor(status) {
    const colors = {
        'scheduled': '#2196f3',
        'completed': '#4caf50',
        'cancelled': '#f44336',
        'rescheduled': '#ff9800',
        'no_show': '#9e9e9e'
    };
    return colors[status] || '#666';
}

// ç²å–ç‹€æ…‹é¡¯ç¤ºæ–‡å­—
function getStatusDisplay(status) {
    const displays = {
        'scheduled': 'å·²æ’å®š',
        'completed': 'å·²å®Œæˆ',
        'cancelled': 'å·²å–æ¶ˆ',
        'rescheduled': 'å·²æ”¹æœŸ',
        'no_show': 'å­¸ç”Ÿç¼ºå¸­'
    };
    return displays[status] || 'æœªçŸ¥';
}

// é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
window.onclick = function(event) {
    const dayModal = document.getElementById('dayModal');
    const createModal = document.getElementById('createLessonModal');
    
    if (event.target == dayModal) {
        closeDayModal();
    } else if (event.target == createModal) {
        closeCreateLessonModal();
    }
}

// è™•ç†å¿«é€Ÿå‰µå»ºèª²ç¨‹è¡¨å–®æäº¤
document.getElementById('quickCreateLessonForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‰µå»ºä¸­...';
    
    try {
        const response = await fetch('{% url "practice_logs:create_lesson" %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('èª²ç¨‹å‰µå»ºæˆåŠŸï¼');
            closeCreateLessonModal();
            // é‡æ–°è¼‰å…¥é é¢ä»¥é¡¯ç¤ºæ–°èª²ç¨‹
            window.location.reload();
        } else {
            alert('å‰µå»ºå¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check"></i> å‰µå»ºèª²ç¨‹';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('å‰µå»ºèª²ç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> å‰µå»ºèª²ç¨‹';
    }
});
</script>
{% endblock %}