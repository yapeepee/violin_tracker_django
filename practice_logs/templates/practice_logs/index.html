{% extends "practice_logs/base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <h1>ğŸ» å°æç´ç·´ç´æ—¥èªŒ</h1>
    <form method='POST' id="practiceForm">
        {% csrf_token %}
        <div class="form-group" data-label="å­¸ç”Ÿå§“å">
            <input type="text" name="student_name" id="studentName" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“å" required
                value="{{ current_student|default:'' }}">
        </div>
        <div class="form-group" data-label="æ›²ç›®åç¨±">
            <input type="text" name="piece" placeholder="è«‹è¼¸å…¥ç·´ç¿’æ›²ç›®" required>
        </div>
        <div class="form-group" data-label="ç·´ç¿’æ™‚é–“">
            <input type="number" name="minutes" placeholder="è«‹è¼¸å…¥ç·´ç¿’æ™‚é–“ï¼ˆåˆ†é˜ï¼‰" min="1" required>
        </div>
        <div class="form-group" data-label="ç·´ç¿’è©•åˆ†">
            <select name="rating" required>
                <option value="" disabled selected>è«‹é¸æ“‡ä»Šæ—¥ç·´ç¿’è©•åˆ†</option>
                {% for i in "12345" %}
                <option value="{{ i }}">{{ i }} æ˜Ÿ â­</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit">è¨˜éŒ„ç·´ç¿’ âœ¨</button>
    </form>

    <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>ğŸµ ç·´ç¿’æ™‚é–“çµ±è¨ˆ</h2>
            <div id="analyticsLink">
                <a href="#" class="btn btn-primary" onclick="goToAnalytics()">
                    æŸ¥çœ‹è©³ç´°åˆ†æ ğŸ“Š
                </a>
            </div>
        </div>
        <div id="studentInfo" class="student-info" style="text-align: center; margin-bottom: 1rem;"></div>
        <div class="chart-wrapper">
            <canvas id="weeklyChart"></canvas>
        </div>
    </div>
</div>

<!-- å°‡ Django è®Šé‡å‚³éçµ¦ JavaScript -->
<script>
    window.INITIAL_STUDENT = "{{ current_student|default:'null' }}";
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
    import { loadWeeklyData } from '{% static "js/charts/charts.js" %}';
    import { setupChartDefaults } from '{% static "js/charts/config.js" %}';

    function goToAnalytics() {
        const studentName = document.getElementById('studentName').value;
        if (studentName) {
            window.location.href = `/analytics/${encodeURIComponent(studentName)}/`;
        } else {
            alert('è«‹å…ˆè¼¸å…¥å­¸ç”Ÿå§“å');
        }
    }
    window.goToAnalytics = goToAnalytics;

    // ç•¶è¡¨å–®æäº¤æ™‚æ›´æ–°åœ–è¡¨
    document.getElementById('practiceForm').addEventListener('submit', function () {
        const studentName = document.getElementById('studentName').value;
        localStorage.setItem('currentStudent', studentName);
    });

    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦æœ‰ç•¶å‰å­¸ç”Ÿ
    document.addEventListener('DOMContentLoaded', function () {
        setupChartDefaults();
        const currentStudent = window.INITIAL_STUDENT === "null" ? null : window.INITIAL_STUDENT;
        const savedStudent = localStorage.getItem('currentStudent');
        const studentToLoad = currentStudent || savedStudent;

        if (studentToLoad) {
            document.getElementById('studentName').value = studentToLoad;
            loadWeeklyData(studentToLoad);
        }
    });
</script>
{% endblock %}