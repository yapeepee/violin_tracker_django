{% extends "practice_logs/base.html" %}
{% load static %}

{% block extra_css %}
<!-- 無需額外 CSS，由 base.html 統一管理 -->
{% endblock %}

{% block content %}
<!-- A. Hero 區 (100vh) - 符合藍圖規範 -->
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <!-- 左文 -->
            <div class="hero-text">
                <h1 class="hero-title">🎵 讓練習更有效率</h1>
                <p class="hero-subtitle">科學化追蹤您的音樂學習旅程，每天都看得見進步</p>
                <a href="#practice-form" class="hero-cta">立即開始記錄 →</a>
                
                <!-- 即時數據展示 -->
                <div class="flex gap-8 mt-12">
                    <div>
                        <div class="text-3xl font-bold text-primary-color">2,847+</div>
                        <div class="text-sm text-gray-600">活躍音樂家</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-primary-color">158K</div>
                        <div class="text-sm text-gray-600">累計練習時數</div>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-primary-color">98%</div>
                        <div class="text-sm text-gray-600">進步滿意度</div>
                    </div>
                </div>
            </div>
            
            <!-- 右圖 -->
            <div class="hero-image">
                <!-- 音樂元素裝飾 -->
                <div class="relative w-full h-full flex items-center justify-center">
                    <div class="text-9xl opacity-10 absolute top-0 right-0 animate-float">🎻</div>
                    <div class="text-8xl opacity-10 absolute bottom-0 left-0 animate-float" style="animation-delay: -2s;">🎸</div>
                    <div class="text-7xl opacity-10 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 animate-float" style="animation-delay: -4s;">🎵</div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- B. Trust 區 (600-800px) - 社會認同 -->
<section class="trust-section section">
    <div class="container">
        <h2 class="text-center text-4xl font-bold mb-12">受到音樂家們的信賴</h2>
        
        <!-- Logo 滾動列 -->
        <div class="trust-logos">
            <span class="trust-logo text-5xl opacity-60">🎼 台北音樂學院</span>
            <span class="trust-logo text-5xl opacity-60">🎻 國家交響樂團</span>
            <span class="trust-logo text-5xl opacity-60">🎷 中華音樂協會</span>
            <span class="trust-logo text-5xl opacity-60">🎺 台灣管樂團</span>
        </div>
        
        <!-- 評價卡片 -->
        <div class="testimonials-grid">
            <div class="testimonial-card">
                <div class="testimonial-rating">★★★★★</div>
                <p class="testimonial-text">"這個系統讓我可以清楚看到學生的進步，非常實用！"</p>
                <div class="testimonial-author">
                    <div class="author-avatar bg-warm-brown text-white flex items-center justify-center text-xl font-bold">陳</div>
                    <div class="author-info">
                        <h4>陳老師</h4>
                        <p>小提琴教師</p>
                    </div>
                </div>
            </div>
            
            <div class="testimonial-card">
                <div class="testimonial-rating">★★★★★</div>
                <p class="testimonial-text">"每天記錄練習，讓我的進步可以量化，真的很棒！"</p>
                <div class="testimonial-author">
                    <div class="author-avatar bg-warm-brown text-white flex items-center justify-center text-xl font-bold">林</div>
                    <div class="author-info">
                        <h4>林同學</h4>
                        <p>音樂系學生</p>
                    </div>
                </div>
            </div>
            
            <div class="testimonial-card">
                <div class="testimonial-rating">★★★★★</div>
                <p class="testimonial-text">"孩子更有動力練習，因為他可以看到自己的成長曲線"</p>
                <div class="testimonial-author">
                    <div class="author-avatar bg-warm-brown text-white flex items-center justify-center text-xl font-bold">張</div>
                    <div class="author-info">
                        <h4>張媽媽</h4>
                        <p>學生家長</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- C. Feature 區 - 功能模組 -->
<section class="feature-section">
    <div class="container">
        <h2 class="text-center text-4xl font-bold mb-4">全方位練習管理</h2>
        <p class="text-center text-xl text-gray-600 mb-12">讓每一次練習都更有意義</p>
        
        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-icon">📊</div>
                <h3 class="feature-title">智慧分析</h3>
                <p class="feature-description">視覺化圖表展示練習成果，讓進步一目了然</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">⏱️</div>
                <h3 class="feature-title">時間追蹤</h3>
                <p class="feature-description">精準記錄每次練習時間，培養規律的練習習慣</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">🎯</div>
                <h3 class="feature-title">目標設定</h3>
                <p class="feature-description">設定個人化的練習目標，逐步完成音樂夢想</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">📝</div>
                <h3 class="feature-title">詳細筆記</h3>
                <p class="feature-description">記錄練習心得與重點，為未來練習提供參考</p>
            </div>
        </div>
    </div>
</section>

<div class="container">

    <!-- 錯誤提示區域 -->
    <div id="errorAlert" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <span id="errorMessage"></span>
        <button type="button" class="absolute top-0 right-0 px-4 py-3" onclick="document.getElementById('errorAlert').classList.add('hidden')">
            <span class="text-2xl">&times;</span>
        </button>
    </div>

    <!-- 練習表單區塊 -->
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8 mb-16" id="practice-form">
        <form method='POST' id="practiceForm">
            {% csrf_token %}
            
            <!-- 隱藏的學生姓名欄位 -->
            <input type="hidden" name="student_name" id="studentName" value="{{ current_student|default:user.username }}">
            
            <!-- 表單標題 -->
            <h3 class="text-3xl font-bold text-center mb-8 text-warm-brown">開始記錄今天的練習</h3>
            
            <!-- 練習日期 -->
            <div class="mb-6">
                <label for="practiceDate" class="block text-base font-semibold text-gray-700 mb-2">
                    <i class="fas fa-calendar-alt mr-2 text-warm-brown"></i>
                    練習日期
                </label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-5 h-5 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zM4 8h12v8H4V8z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <input type="date" 
                           name="date" 
                           id="practiceDate" 
                           class="form-input pl-10" 
                           required>
                </div>
            </div>

            <!-- 樂器選擇區 -->
            <div class="mb-6">
                <label for="id_instrument" class="block text-base font-semibold text-gray-700 mb-2">
                    <i class="fas fa-music mr-2 text-warm-brown"></i>
                    選擇練習樂器
                </label>
                <select name="instrument" id="id_instrument" 
                        class="form-input text-base p-3" 
                        required>
                    <option value="" selected>請選擇樂器...</option>
                    <optgroup label="弦樂器">
                        <option value="violin">🎻 小提琴</option>
                        <option value="viola">🎻 中提琴</option>
                        <option value="cello">🎻 大提琴</option>
                        <option value="double_bass">🎻 低音提琴</option>
                        <option value="guitar">🎸 吉他</option>
                        <option value="bass">🎸 貝斯</option>
                        <option value="ukulele">🎸 烏克麗麗</option>
                        <option value="harp">🎵 豎琴</option>
                    </optgroup>
                    <optgroup label="管樂器">
                        <option value="flute">🎵 長笛</option>
                        <option value="clarinet">🎵 單簧管</option>
                        <option value="oboe">🎵 雙簧管</option>
                        <option value="saxophone">🎷 薩克斯風</option>
                        <option value="trumpet">🎺 小號</option>
                        <option value="trombone">🎺 長號</option>
                        <option value="french_horn">🎺 法國號</option>
                    </optgroup>
                    <optgroup label="其他">
                        <option value="piano">🎹 鋼琴</option>
                        <option value="drums">🥁 爵士鼓</option>
                        <option value="voice">🎤 聲樂</option>
                    </optgroup>
                </select>
                <p class="mt-2 text-sm text-gray-500">請選擇您今天要練習的樂器</p>
            </div>

            <!-- 練習曲目 -->
            <div class="mb-6">
                <label for="piece" class="block text-base font-semibold text-gray-700 mb-2">
                    <i class="fas fa-music mr-2 text-warm-brown"></i>
                    練習曲目 *
                </label>
                <input type="text" 
                       name="piece" 
                       id="piece"
                       class="form-input text-lg py-4 border-2 hover:border-warm-brown" 
                       placeholder="例如：巴哈無伴奏組曲第一號" 
                       required 
                       maxlength="100">
                <p class="mt-2 text-sm text-gray-600 italic">請輸入今天主要練習的樂曲名稱</p>
            </div>
            
            <!-- 練習時間 - 較小欄位 -->
            <div class="mb-6">
                <label for="minutes" class="block text-sm font-medium text-dark-brown mb-2">練習時間</label>
                <div class="flex items-center max-w-xs">
                    <input type="number" 
                           name="minutes" 
                           id="minutes"
                           class="w-24 px-3 py-2 text-center border border-beige rounded-l-lg focus:ring-2 focus:ring-warm-brown focus:border-transparent" 
                           placeholder="30" 
                           min="1" 
                           max="600" 
                           required>
                    <span class="px-4 py-2 bg-beige text-dark-brown rounded-r-lg border border-l-0 border-beige">分鐘</span>
                </div>
            </div>

            <!-- 練習重點區 -->
            <div class="mb-6">
                <label class="block text-lg font-semibold text-warm-brown mb-3">練習重點</label>
                <div class="flex flex-wrap gap-2">
                    <input type="radio" id="focus-technique" name="focus" value="technique" class="hidden peer/technique" checked>
                    <label for="focus-technique" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/technique:bg-warm-brown peer-checked/technique:text-white transition-all">
                        🎯 技巧練習
                    </label>
                    
                    <input type="radio" id="focus-expression" name="focus" value="expression" class="hidden peer/expression">
                    <label for="focus-expression" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/expression:bg-warm-brown peer-checked/expression:text-white transition-all">
                        🎭 表現力
                    </label>
                    
                    <input type="radio" id="focus-rhythm" name="focus" value="rhythm" class="hidden peer/rhythm">
                    <label for="focus-rhythm" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/rhythm:bg-warm-brown peer-checked/rhythm:text-white transition-all">
                        🥁 節奏
                    </label>
                    
                    <input type="radio" id="focus-sight" name="focus" value="sight_reading" class="hidden peer/sight">
                    <label for="focus-sight" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/sight:bg-warm-brown peer-checked/sight:text-white transition-all">
                        👁️ 視奏
                    </label>
                    
                    <input type="radio" id="focus-memory" name="focus" value="memorization" class="hidden peer/memory">
                    <label for="focus-memory" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/memory:bg-warm-brown peer-checked/memory:text-white transition-all">
                        🧠 記譜
                    </label>
                    
                    <input type="radio" id="focus-ensemble" name="focus" value="ensemble" class="hidden peer/ensemble">
                    <label for="focus-ensemble" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/ensemble:bg-warm-brown peer-checked/ensemble:text-white transition-all">
                        👥 重奏
                    </label>
                    
                    <input type="radio" id="focus-other" name="focus" value="other" class="hidden peer/other">
                    <label for="focus-other" class="px-4 py-2 text-sm font-medium text-dark-brown bg-white border border-light-brown rounded-full cursor-pointer hover:bg-beige peer-checked/other:bg-warm-brown peer-checked/other:text-white transition-all">
                        ✨ 其他
                    </label>
                </div>
                <p class="mt-3 text-sm text-gray-500">選擇本次練習的主要重點</p>
            </div>

            <!-- 精緻評分系統 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-dark-brown mb-4">練習評分 *</label>
                <div class="max-w-sm mx-auto">
                    <!-- 迷你鋼琴 -->
                    <div class="flex justify-center gap-0.5 mb-6">
                        <div class="piano-key w-8 h-12 bg-white border border-gray-300 rounded-b-sm cursor-pointer hover:bg-gray-100 transition-all duration-200" data-rating="1"></div>
                        <div class="piano-key w-8 h-12 bg-white border border-gray-300 rounded-b-sm cursor-pointer hover:bg-gray-100 transition-all duration-200" data-rating="2"></div>
                        <div class="piano-key w-8 h-12 bg-white border border-gray-300 rounded-b-sm cursor-pointer hover:bg-gray-100 transition-all duration-200" data-rating="3"></div>
                        <div class="piano-key w-8 h-12 bg-white border border-gray-300 rounded-b-sm cursor-pointer hover:bg-gray-100 transition-all duration-200" data-rating="4"></div>
                        <div class="piano-key w-8 h-12 bg-white border border-gray-300 rounded-b-sm cursor-pointer hover:bg-gray-100 transition-all duration-200" data-rating="5"></div>
                    </div>
                    
                    <!-- 優雅滑桿 -->
                    <div class="relative mb-8">
                        <div class="w-full h-1 bg-beige rounded-full">
                            <div id="sliderFill" class="h-full bg-warm-brown rounded-full transition-all duration-300" style="width: 50%"></div>
                        </div>
                        <input type="range" 
                               id="ratingSlider" 
                               class="absolute w-full h-1 top-0 opacity-0 cursor-pointer" 
                               min="1" 
                               max="5" 
                               value="3" 
                               step="1">
                        <div class="flex justify-between mt-2 text-xs text-gray-500">
                            <span>1</span>
                            <span>2</span>
                            <span>3</span>
                            <span>4</span>
                            <span>5</span>
                        </div>
                    </div>
                    
                    <!-- 評分文字 -->
                    <div class="text-center">
                        <span class="text-2xl font-bold text-warm-brown" id="ratingValue">3</span>
                        <span class="text-dark-brown"> 分 - </span>
                        <span class="text-warm-brown italic" id="ratingDesc">普通</span>
                    </div>
                </div>
                <input type="hidden" id="rating" name="rating" value="3" required>
            </div>

            <!-- 練習筆記 -->
            <div class="mb-8">
                <label for="notes" class="block text-sm font-medium text-dark-brown mb-2">練習筆記</label>
                <textarea name="notes" 
                          id="notes"
                          class="w-full px-4 py-3 border border-beige rounded-lg focus:ring-2 focus:ring-warm-brown focus:border-transparent transition-all duration-200 resize-none" 
                          rows="4" 
                          placeholder="記錄今天的練習內容、感受、需要改進的地方或下次練習的重點..." 
                          maxlength="1000"></textarea>
                <p class="mt-2 text-sm text-gray-600 italic">詳細記錄練習的內容、感受和需要注意的事項</p>
            </div>

            <!-- 提交按鈕 -->
            <div class="text-center">
                <button type="submit" class="hero-cta">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    <i class="fas fa-save mr-2"></i>
                    記錄練習 ✨
                </button>
            </div>
        </form>
    </div>

    <div class="bg-white rounded-lg p-6 shadow-warm border border-beige mt-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-serif text-dark-brown">🎵 練習時間統計</h2>
            <div id="analyticsLink">
                <a href="#" class="btn-primary" onclick="goToAnalytics(); return false;">
                    查看詳細分析 📊
                </a>
            </div>
        </div>
        <div id="studentInfo" class="text-center text-lg text-gray-600 my-4"></div>
        <div class="relative">
            <div id="chartLoading" class="absolute inset-0 flex items-center justify-center hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-warm-brown"></div>
            </div>
            <canvas id="weeklyChart"></canvas>
        </div>
    </div>
</div>


<!-- 將 Django 變量傳遞給 JavaScript -->
<script>
    window.INITIAL_STUDENT = "{{ current_student|default:'null' }}";
    window.CSRF_TOKEN = "{{ csrf_token }}";
</script>

<!-- 3D角色配置已移除 -->

<!-- Three.js引用已移除 -->

<!-- 3D角色系統已移除 -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- 移除現代標籤選擇器 -->
<script type="module">
    // 導入所需模組
    import { loadWeeklyData } from '{% static "js/charts/charts.js" %}';
    import { setupChartDefaults } from '{% static "js/charts/config.js" %}';
    import { handleError } from '{% static "js/utils.js" %}';

    // 等待 Chart.js 載入
    async function waitForChart() {
        if (typeof Chart !== 'undefined') return;

        return new Promise((resolve) => {
            const checkChart = () => {
                if (typeof Chart !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(checkChart, 50);
                }
            };
            checkChart();
        });
    }

    // 顯示錯誤信息
    function showError(message) {
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = message;
        errorAlert.classList.remove('hidden');
    }

    // 顯示/隱藏載入動畫
    function toggleLoading(show) {
        const chartLoading = document.getElementById('chartLoading');
        if (show) {
            chartLoading.classList.remove('hidden');
        } else {
            chartLoading.classList.add('hidden');
        }
    }

    // 3D角色功能已移除

    // Three.js相關代碼已移除

    // 角色佔位符功能已移除

    async function initializeApp() {
        try {
            // 等待 Chart.js
            await waitForChart();

            // 設置圖表預設值
            setupChartDefaults();

            // 初始化樂器選擇器
            const instrumentSelect = document.getElementById('id_instrument');
            const preferredInstrument = localStorage.getItem('preferredInstrument') || 'violin';
            instrumentSelect.value = preferredInstrument;
            
            // 監聽樂器選擇變化
            instrumentSelect.addEventListener('change', function() {
                const selectedInstrument = this.value;
                if (selectedInstrument) {
                    localStorage.setItem('preferredInstrument', selectedInstrument);
                    
                    // 更新圖表
                    const studentName = document.getElementById('studentName').value;
                    if (studentName) {
                        loadWeeklyData(studentName, selectedInstrument);
                    }
                }
            });

            // 頁面載入時檢查是否有當前學生
            const currentStudent = window.INITIAL_STUDENT === "null" ? null : window.INITIAL_STUDENT;
            const savedStudent = localStorage.getItem('currentStudent');
            const studentToLoad = currentStudent || savedStudent;

            if (studentToLoad) {
                document.getElementById('studentName').value = studentToLoad;
                try {
                    toggleLoading(true);
                    await loadWeeklyData(studentToLoad);
                } catch (error) {
                    showError('載入圖表數據時發生錯誤：' + error.message);
                } finally {
                    toggleLoading(false);
                }
            }

            // 表單提交處理
            document.getElementById('practiceForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const form = this;
                const studentName = document.getElementById('studentName').value;

                try {
                    toggleLoading(true);
                    
                    // 3D角色動畫已移除
                    
                    const formData = new FormData(form);
                    const data = {};
                    formData.forEach((value, key) => {
                        data[key] = value;
                    });

                    const response = await fetch('', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.CSRF_TOKEN,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.redirected) {
                        // 如果後端返回重定向，我們就跟隨重定向
                        window.location.href = response.url;
                        return;
                    }

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || '提交練習記錄時發生錯誤');
                    }

                    // 保存當前學生
                    localStorage.setItem('currentStudent', studentName);

                    // 重置表單
                    form.reset();
                    document.getElementById('studentName').value = studentName;

                    // 重新載入圖表
                    await loadWeeklyData(studentName);

                    // 3D角色慶祝動畫已移除

                    // 顯示成功消息
                    const successAlert = document.createElement('div');
                    successAlert.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative mb-4';
                    successAlert.innerHTML = `
                        <i class="fas fa-check-circle mr-2"></i>
                        練習記錄已保存成功！
                        <button type="button" class="absolute top-0 right-0 px-4 py-3" onclick="this.parentElement.remove()">
                            <span class="text-2xl">&times;</span>
                        </button>
                    `;
                    form.insertAdjacentElement('beforebegin', successAlert);

                    // 3秒後自動關閉成功消息
                    setTimeout(() => {
                        successAlert.remove();
                    }, 3000);

                } catch (error) {
                    // 3D角色錯誤動畫已移除
                    showError(error.message);
                } finally {
                    toggleLoading(false);
                }
            });

        } catch (error) {
            console.error('初始化失敗:', error);
            showError('初始化應用時發生錯誤');
        }
    }

    // 導航到分析頁面
    window.goToAnalytics = function () {
        const studentName = document.getElementById('studentName').value;
        if (studentName) {
            window.location.href = `/analytics/${encodeURIComponent(studentName)}/`;
        } else {
            showError('請先輸入學生姓名');
        }
    };

    // 啟動應用
    initializeApp().catch(error => {
        console.error('應用啟動失敗:', error);
        showError('應用啟動失敗');
    });

    // 設置默認日期為今天
    document.getElementById('practiceDate').value = new Date().toISOString().split('T')[0];
    
    // 精緻評分系統
    const ratingSlider = document.getElementById('ratingSlider');
    const ratingInput = document.getElementById('rating');
    const ratingValue = document.getElementById('ratingValue');
    const ratingDesc = document.getElementById('ratingDesc');
    const sliderFill = document.getElementById('sliderFill');
    const pianoKeys = document.querySelectorAll('.piano-key');
    
    // 評分描述
    const ratingDescriptions = {
        1: '需要加強',
        2: '尚可',
        3: '普通',
        4: '良好',
        5: '優秀'
    };
    
    // 更新評分顯示
    function updateRatingDisplay(rating) {
        // 更新數值和描述
        ratingValue.textContent = rating;
        ratingDesc.textContent = ratingDescriptions[rating];
        ratingInput.value = rating;
        
        // 更新滑桿填充
        const percentage = ((rating - 1) / 4) * 100;
        sliderFill.style.width = percentage + '%';
        
        // 更新鋼琴鍵盤
        pianoKeys.forEach((key, index) => {
            key.classList.remove('bg-warm-brown', 'text-white');
            key.classList.add('bg-white');
            if (index < rating) {
                setTimeout(() => {
                    key.classList.remove('bg-white');
                    key.classList.add('bg-warm-brown', 'text-white', 'transform', 'translate-y-0.5');
                }, index * 50);
            }
        });
    }
    
    // 滑桿事件
    ratingSlider.addEventListener('input', function() {
        updateRatingDisplay(parseInt(this.value));
    });
    
    // 鋼琴鍵點擊事件
    pianoKeys.forEach((key, index) => {
        key.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            ratingSlider.value = rating;
            updateRatingDisplay(rating);
        });
    });
    
    // 初始化顯示
    updateRatingDisplay(3);

    // 表單驗證增強
    document.getElementById('practiceForm').addEventListener('submit', function(e) {
        const rating = document.getElementById('rating').value;
        if (!rating || rating < 1 || rating > 5) {
            e.preventDefault();
            showError('請選擇練習評分（1-5分）');
            return false;
        }
        
        const minutes = document.getElementById('minutes').value;
        if (!minutes || minutes < 1 || minutes > 600) {
            e.preventDefault();
            showError('練習時間必須在1-600分鐘之間');
            return false;
        }
        
        return true;
    });

    // 模態框控制函數
    window.showLoginModal = function() {
        document.getElementById('loginModal').classList.remove('hidden');
    };

    window.showRegisterModal = function() {
        document.getElementById('registerModal').classList.remove('hidden');
    };

    window.switchToRegister = function() {
        document.getElementById('loginModal').classList.add('hidden');
        setTimeout(() => showRegisterModal(), 300);
    };

    window.switchToLogin = function() {
        document.getElementById('registerModal').classList.add('hidden');
        setTimeout(() => showLoginModal(), 300);
    };

    // 處理登入表單提交
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // 獲取正確的 CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('{% url "practice_logs:login" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message || '登入成功！');
                    location.reload();
                } else {
                    alert(data.message || '登入失敗，請檢查用戶名和密碼');
                }
            })
            .catch(error => {
                console.error('登入錯誤:', error);
                alert('登入時發生錯誤，請稍後再試');
            });
        });
    }

    // 處理註冊表單提交
    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
        registerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        // 獲取正確的 CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('{% url "practice_logs:register" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(data.message || '註冊成功！');
                location.reload();
            } else {
                alert(data.message || '註冊失敗，請檢查信息是否正確');
            }
        })
        .catch(error => {
            console.error('註冊錯誤:', error);
            alert('註冊時發生錯誤，請稍後再試');
        });
        });
    }
</script>

<!-- 登入模態框 -->
<div class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden" id="loginModal">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl shadow-2xl max-w-md w-full relative overflow-hidden">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-warm-brown via-light-brown to-warm-brown"></div>
            <div class="text-center pt-8 pb-4">
                <div class="text-5xl mb-4 animate-glow">🎻</div>
                <h5 class="text-3xl font-serif text-gray-800 mb-2">歡迎回來</h5>
                <button type="button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700" onclick="document.getElementById('loginModal').classList.add('hidden')">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-8 pt-0">
                <form id="loginForm" method="post">
                    {% csrf_token %}
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">用戶名或電子郵件</label>
                        <input type="text" name="username" class="form-input" required>
                    </div>
                    <div class="mb-5">
                        <label class="block text-sm font-medium text-gray-700 mb-2">密碼</label>
                        <input type="password" name="password" class="form-input" required>
                    </div>
                    <button type="submit" class="w-full btn-primary">登入</button>
                </form>
            </div>
            <div class="text-center pb-8">
                <div class="text-gray-600">
                    還沒有帳戶？<a href="#" class="text-warm-brown font-semibold hover:underline" onclick="switchToRegister()">立即註冊</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 註冊模態框 -->
<div class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden" id="registerModal">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl shadow-2xl max-w-md w-full relative overflow-hidden">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-warm-brown via-light-brown to-warm-brown"></div>
            <div class="text-center pt-8 pb-4">
                <div class="text-5xl mb-4 animate-glow">🎻</div>
                <h5 class="text-3xl font-serif text-gray-800 mb-2">加入我們</h5>
                <button type="button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700" onclick="document.getElementById('registerModal').classList.add('hidden')">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-8 pt-0">
                <form id="registerForm" method="post">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">用戶名</label>
                        <input type="text" name="username" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">電子郵件</label>
                        <input type="email" name="email" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">中文姓名</label>
                        <input type="text" name="chinese_name" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">角色</label>
                        <select name="role" class="form-input" required>
                            <option value="student">學生</option>
                            <option value="teacher">教師</option>
                            <option value="parent">家長</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">密碼</label>
                        <input type="password" name="password1" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">確認密碼</label>
                        <input type="password" name="password2" class="form-input" required>
                    </div>
                    <button type="submit" class="w-full btn-primary">註冊</button>
                </form>
            </div>
            <div class="text-center pb-8">
                <div class="text-gray-600">
                    已有帳戶？<a href="#" class="text-warm-brown font-semibold hover:underline" onclick="switchToLogin()">立即登入</a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}