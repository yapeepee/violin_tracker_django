{% extends 'practice_logs/base.html' %}
{% load static %}

{% block title %}å­¸ç”Ÿå„€è¡¨æ¿ - {{ user.profile.display_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/classical_theme.css' %}">
<style>
.dashboard-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.welcome-section {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.welcome-section::before {
    content: "â™ª";
    position: absolute;
    top: 20px;
    right: 30px;
    font-size: 3rem;
    color: #6c757d;
    opacity: 0.3;
}

.stat-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.stat-card .icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
    display: block;
}

.stat-card.sessions .icon { color: #17a2b8; }
.stat-card.time .icon { color: #28a745; }
.stat-card.rating .icon { color: #ffc107; }
.stat-card.streak .icon { color: #dc3545; }

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.dashboard-section {
    background: white;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.section-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
}

.recent-practice-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #f8f9fa;
}

.recent-practice-item:last-child {
    border-bottom: none;
}

.practice-info {
    flex: 1;
}

.practice-date {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 5px;
}

.practice-details {
    font-size: 0.9rem;
    color: #6c757d;
}

.practice-rating {
    display: flex;
    align-items: center;
    font-size: 1.1rem;
}

.star-rating {
    color: #ffc107;
    margin-left: 5px;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px 20px;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    color: white;
}

.action-btn.primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
}

.action-btn.success {
    background: linear-gradient(45deg, #28a745, #1e7e34);
}

.action-btn.info {
    background: linear-gradient(45deg, #17a2b8, #138496);
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    color: white;
    text-decoration: none;
}

.action-btn i {
    margin-right: 8px;
    font-size: 1.1rem;
}

.no-data {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 30px;
    background: #f8f9fa;
    border-radius: 8px;
}

.teacher-list {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.teacher-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
    flex: 1;
    min-width: 200px;
}

.teacher-name {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 5px;
}

.teacher-since {
    font-size: 0.85rem;
    color: #6c757d;
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 15px;
    }
    
    .stat-cards {
        grid-template-columns: 1fr;
    }
    
    .welcome-section {
        padding: 20px;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- æ­¡è¿å€åŸŸ -->
    <div class="welcome-section">
        <h1 class="mb-3">æ­¡è¿å›ä¾†ï¼Œ{{ user.profile.display_name }}ï¼</h1>
        <p class="lead mb-0">
            {% if user.profile.skill_level %}
                ç•¶å‰ç¨‹åº¦ï¼š{{ user.profile.get_skill_level_display }}
            {% endif %}
            {% if user.profile.learning_start_date %}
                | å­¸ç¿’å°æç´å·² {{ user.profile.learning_duration_days }} å¤©
            {% endif %}
        </p>
    </div>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stat-cards">
        <div class="stat-card sessions">
            <span class="icon">ğŸ“Š</span>
            <div class="stat-number">{{ practice_stats.total_sessions|default:"0" }}</div>
            <div class="stat-label">ç·´ç¿’æ¬¡æ•¸</div>
        </div>
        
        <div class="stat-card time">
            <span class="icon">â±ï¸</span>
            <div class="stat-number">{{ practice_stats.total_minutes|default:"0" }}</div>
            <div class="stat-label">ç¸½ç·´ç¿’æ™‚é–“ (åˆ†é˜)</div>
        </div>
        
        <div class="stat-card rating">
            <span class="icon">â­</span>
            <div class="stat-number">{{ practice_stats.average_rating|floatformat:1|default:"0.0" }}</div>
            <div class="stat-label">å¹³å‡è©•åˆ†</div>
        </div>
        
        <div class="stat-card streak">
            <span class="icon">ğŸ”¥</span>
            <div class="stat-number">{{ practice_stats.recent_sessions|default:"0" }}</div>
            <div class="stat-label">æœ¬é€±ç·´ç¿’æ¬¡æ•¸</div>
        </div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="dashboard-section">
        <h2 class="section-title">å¿«é€Ÿæ“ä½œ</h2>
        <div class="quick-actions">
            <a href="{% url 'practice_logs:add_log' %}" class="action-btn primary">
                <i class="fas fa-plus"></i>
                æ–°å¢ç·´ç¿’è¨˜éŒ„
            </a>
            <a href="{% url 'practice_logs:analytics' student_name=user.profile.display_name %}" class="action-btn info">
                <i class="fas fa-chart-bar"></i>
                æŸ¥çœ‹åˆ†æå ±å‘Š
            </a>
            <a href="{% url 'practice_logs:achievements' %}" class="action-btn success">
                <i class="fas fa-trophy"></i>
                æˆ‘çš„æˆå°±
            </a>
        </div>
    </div>

    <div class="row">
        <!-- æœ€è¿‘ç·´ç¿’è¨˜éŒ„ -->
        <div class="col-lg-8">
            <div class="dashboard-section">
                <h2 class="section-title">æœ€è¿‘ç·´ç¿’è¨˜éŒ„</h2>
                {% if recent_practices %}
                    {% for practice in recent_practices %}
                        <div class="recent-practice-item">
                            <div class="practice-info">
                                <div class="practice-date">{{ practice.date|date:"Yå¹´mæœˆdæ—¥" }}</div>
                                <div class="practice-details">
                                    {% if practice.focus %}{{ practice.get_focus_display }} â€¢ {% endif %}
                                    {{ practice.minutes }} åˆ†é˜
                                    {% if practice.notes %}
                                        <br><small>{{ practice.notes|truncatechars:50 }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="practice-rating">
                                {{ practice.rating|floatformat:1 }}
                                <span class="star-rating">â­</span>
                            </div>
                        </div>
                    {% endfor %}
                    <div class="text-center mt-3">
                        <a href="{% url 'practice_logs:my_practices' %}" class="btn btn-outline-primary">
                            æŸ¥çœ‹æ‰€æœ‰è¨˜éŒ„
                        </a>
                    </div>
                {% else %}
                    <div class="no-data">
                        <p>é‚„æ²’æœ‰ç·´ç¿’è¨˜éŒ„</p>
                        <a href="{% url 'practice_logs:add_log' %}" class="btn btn-primary">
                            é–‹å§‹ç¬¬ä¸€æ¬¡ç·´ç¿’è¨˜éŒ„
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- å´é‚Šæ¬„ä¿¡æ¯ -->
        <div class="col-lg-4">
            <!-- æˆ‘çš„æ•™å¸« -->
            <div class="dashboard-section">
                <h2 class="section-title">æˆ‘çš„æ•™å¸«</h2>
                {% if teachers %}
                    <div class="teacher-list">
                        {% for relation in teachers %}
                            <div class="teacher-card">
                                <div class="teacher-name">
                                    {{ relation.teacher.profile.display_name|default:relation.teacher.username }}
                                </div>
                                <div class="teacher-since">
                                    è‡ª {{ relation.start_date|date:"Yå¹´mæœˆ" }} é–‹å§‹
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-data">
                        å°šæœªæŒ‡å®šæ•™å¸«
                    </div>
                {% endif %}
            </div>

            <!-- å­¸ç¿’ç›®æ¨™ -->
            {% if user.profile.learning_goals %}
            <div class="dashboard-section">
                <h2 class="section-title">å­¸ç¿’ç›®æ¨™</h2>
                <p class="text-muted">{{ user.profile.learning_goals }}</p>
            </div>
            {% endif %}

            <!-- å–œæ„›çš„ä½œæ›²å®¶ -->
            {% if user.profile.favorite_composers %}
            <div class="dashboard-section">
                <h2 class="section-title">å–œæ„›çš„ä½œæ›²å®¶</h2>
                <p class="text-muted">{{ user.profile.favorite_composers }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // çµ±è¨ˆå¡ç‰‡å‹•ç•«
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.6s ease';
            
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100);
        }, index * 150);
    });
    
    // ç‚ºæ•¸å­—æ·»åŠ å‹•ç•«æ•ˆæœ
    const statNumbers = document.querySelectorAll('.stat-number');
    statNumbers.forEach(number => {
        const finalValue = parseInt(number.textContent) || parseFloat(number.textContent) || 0;
        let currentValue = 0;
        const increment = finalValue / 50; // 50æ­¥å®Œæˆå‹•ç•«
        
        const timer = setInterval(() => {
            currentValue += increment;
            if (currentValue >= finalValue) {
                currentValue = finalValue;
                clearInterval(timer);
            }
            
            if (Number.isInteger(finalValue)) {
                number.textContent = Math.floor(currentValue);
            } else {
                number.textContent = currentValue.toFixed(1);
            }
        }, 30);
    });
});
</script>
{% endblock %}