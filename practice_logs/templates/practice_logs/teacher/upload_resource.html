{% extends 'practice_logs/teacher/base_teacher.html' %}
{% load static %}

{% block title %}ä¸Šå‚³è³‡æº - æ•™å¸«ç³»çµ±{% endblock %}

{% block extra_css %}
<style>
/* ä¸Šå‚³é é¢å®¹å™¨ */
.upload-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

/* é é¢æ¨™é¡Œ */
.page-title {
    font-size: 2rem;
    color: #333;
    margin-bottom: 10px;
}

.page-subtitle {
    color: #666;
    margin-bottom: 30px;
}

/* è¡¨å–®å¡ç‰‡ */
.upload-form-card {
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.1);
}

/* è¡¨å–®å€å¡Š */
.form-section {
    margin-bottom: 30px;
    padding-bottom: 30px;
    border-bottom: 1px solid #eee;
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.section-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #2c5f3d;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* è¡¨å–®å…ƒç´  */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-weight: 500;
    color: #333;
    margin-bottom: 8px;
}

.required {
    color: #d32f2f;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #2c5f3d;
}

textarea.form-control {
    resize: vertical;
    min-height: 100px;
}

/* æª”æ¡ˆä¸Šå‚³å€ */
.file-upload-area {
    border: 2px dashed #2c5f3d;
    border-radius: 15px;
    padding: 40px;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.file-upload-area:hover {
    background: #e8f5e9;
    border-color: #1b5e20;
}

.file-upload-area.dragover {
    background: #e8f5e9;
    border-color: #1b5e20;
    transform: scale(1.02);
}

.upload-icon {
    font-size: 3rem;
    color: #2c5f3d;
    margin-bottom: 15px;
}

.upload-text {
    font-size: 1.1rem;
    color: #333;
    margin-bottom: 10px;
}

.upload-hint {
    font-size: 0.9rem;
    color: #666;
}

.file-input {
    display: none;
}

/* å·²é¸æ“‡æª”æ¡ˆé¡¯ç¤º */
.selected-file {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #e8f5e9;
    border-radius: 10px;
    margin-top: 15px;
}

.file-icon {
    font-size: 2rem;
    color: #2c5f3d;
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: 500;
    color: #333;
}

.file-size {
    font-size: 0.9rem;
    color: #666;
}

.remove-file {
    padding: 8px 15px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.remove-file:hover {
    background: #d32f2f;
}

/* é¸æ“‡æ¡†ç¾¤çµ„ */
.select-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

/* æ¨™ç±¤è¼¸å…¥ */
.tags-input {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    min-height: 50px;
    cursor: text;
}

.tag-item {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 12px;
    background: #2c5f3d;
    color: white;
    border-radius: 20px;
    font-size: 0.9rem;
}

.tag-remove {
    cursor: pointer;
    font-size: 1rem;
}

.tag-input-field {
    border: none;
    outline: none;
    flex: 1;
    min-width: 100px;
    font-size: 1rem;
}

/* å­¸ç”Ÿé¸æ“‡ */
.student-select {
    max-height: 200px;
    overflow-y: auto;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 10px;
}

.student-checkbox {
    display: block;
    padding: 8px;
    margin-bottom: 5px;
    transition: background 0.3s ease;
}

.student-checkbox:hover {
    background: #f5f5f5;
}

.student-checkbox input {
    margin-right: 10px;
}

/* æäº¤æŒ‰éˆ•å€ */
.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 30px;
}

.btn {
    padding: 12px 30px;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #2c5f3d;
    color: white;
}

.btn-primary:hover {
    background: #245030;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

/* é€²åº¦æ¢ */
.upload-progress {
    display: none;
    margin-top: 20px;
}

.progress-bar {
    height: 20px;
    background: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #2c5f3d;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
}

/* éŒ¯èª¤è¨Šæ¯ */
.error-message {
    padding: 15px;
    background: #ffebee;
    color: #c62828;
    border-radius: 10px;
    margin-bottom: 20px;
    display: none;
}

/* æˆåŠŸè¨Šæ¯ */
.success-message {
    padding: 15px;
    background: #e8f5e9;
    color: #2e7d32;
    border-radius: 10px;
    margin-bottom: 20px;
    display: none;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    .upload-container {
        padding: 10px;
    }
    
    .upload-form-card {
        padding: 20px;
    }
    
    .select-grid {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <h1 class="page-title">ğŸ“¤ ä¸Šå‚³æ•™å­¸è³‡æº</h1>
    <p class="page-subtitle">ä¸Šå‚³æ¨‚è­œã€æ•™å­¸å½±ç‰‡ã€éŸ³é »ç¤ºç¯„ç­‰è³‡æºï¼Œèˆ‡å­¸ç”Ÿåˆ†äº«</p>
    
    <div class="upload-form-card">
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <form id="uploadForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- åŸºæœ¬è³‡è¨Š -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-info-circle"></i> åŸºæœ¬è³‡è¨Š
                </h2>
                
                <div class="form-group">
                    <label class="form-label">
                        è³‡æºæ¨™é¡Œ <span class="required">*</span>
                    </label>
                    <input type="text" 
                           name="title" 
                           class="form-control" 
                           placeholder="ä¾‹å¦‚ï¼šå·´å“ˆå°æ­¥èˆæ›² Gå¤§èª¿æ¨‚è­œ"
                           required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è³‡æºæè¿°</label>
                    <textarea name="description" 
                              class="form-control" 
                              placeholder="æè¿°é€™å€‹è³‡æºçš„å…§å®¹ã€ç”¨é€”ã€é©åˆç¨‹åº¦ç­‰..."></textarea>
                </div>
                
                <div class="select-grid">
                    <div class="form-group">
                        <label class="form-label">
                            è³‡æºåˆ†é¡ <span class="required">*</span>
                        </label>
                        <select name="category" class="form-control" required>
                            <option value="">é¸æ“‡åˆ†é¡</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è³‡æºé¡å‹</label>
                        <select name="resource_type" class="form-control">
                            <option value="other">å…¶ä»–</option>
                            <option value="pdf">PDFæ–‡ä»¶</option>
                            <option value="video">æ•™å­¸å½±ç‰‡</option>
                            <option value="audio">éŸ³é »ç¤ºç¯„</option>
                            <option value="image">åœ–ç‰‡</option>
                            <option value="link">å¤–éƒ¨é€£çµ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é©åˆç¨‹åº¦</label>
                        <select name="difficulty_level" class="form-control">
                            <option value="all">ä¸é™</option>
                            <option value="beginner">åˆç´š</option>
                            <option value="intermediate">ä¸­ç´š</option>
                            <option value="advanced">é«˜ç´š</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- æª”æ¡ˆä¸Šå‚³ -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-file-upload"></i> æª”æ¡ˆä¸Šå‚³
                </h2>
                
                <div class="file-upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <div class="upload-text">é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•ä¸Šå‚³</div>
                    <div class="upload-hint">æ”¯æ´ PDFã€å½±ç‰‡ã€éŸ³é »ã€åœ–ç‰‡ç­‰æ ¼å¼ï¼Œæœ€å¤§ 50MB</div>
                    <input type="file" 
                           name="file" 
                           id="fileInput" 
                           class="file-input"
                           accept=".pdf,.doc,.docx,.mp4,.avi,.mov,.mp3,.wav,.jpg,.jpeg,.png,.gif">
                </div>
                
                <div id="selectedFile" style="display: none;"></div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">æˆ–æä¾›å¤–éƒ¨é€£çµ</label>
                    <input type="url" 
                           name="external_link" 
                           class="form-control" 
                           placeholder="https://example.com/resource">
                </div>
            </div>
            
            <!-- é¡å¤–è³‡è¨Š -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-tags"></i> é¡å¤–è³‡è¨Š
                </h2>
                
                <div class="form-group">
                    <label class="form-label">æ¨™ç±¤</label>
                    <div class="tags-input" id="tagsContainer">
                        <input type="text" 
                               class="tag-input-field" 
                               id="tagInput"
                               placeholder="è¼¸å…¥æ¨™ç±¤å¾ŒæŒ‰ Enter">
                    </div>
                    <input type="hidden" name="tags" id="tagsHidden">
                    <small class="form-text text-muted">ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹æ¨™ç±¤</small>
                </div>
                
                <div class="select-grid">
                    <div class="form-group">
                        <label class="form-label">ä½œæ›²å®¶</label>
                        <input type="text" 
                               name="composer" 
                               class="form-control" 
                               placeholder="ä¾‹å¦‚ï¼šå·´å“ˆã€è«æœ­ç‰¹">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ›²ç›®åç¨±</label>
                        <input type="text" 
                               name="piece_name" 
                               class="form-control" 
                               placeholder="ä¾‹å¦‚ï¼šå°æ­¥èˆæ›² Gå¤§èª¿">
                    </div>
                </div>
            </div>
            
            <!-- åˆ†äº«è¨­å®š -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-share-alt"></i> åˆ†äº«è¨­å®š
                </h2>
                
                <div class="form-group">
                    <label class="form-check">
                        <input type="checkbox" 
                               name="is_public" 
                               value="true"
                               class="form-check-input">
                        <span class="form-check-label">
                            å…¬é–‹æ­¤è³‡æºï¼ˆå…¶ä»–æ•™å¸«ä¹Ÿèƒ½æŸ¥çœ‹å’Œä½¿ç”¨ï¼‰
                        </span>
                    </label>
                </div>
                
                {% if students %}
                <div class="form-group">
                    <label class="form-label">åˆ†äº«çµ¦ç‰¹å®šå­¸ç”Ÿ</label>
                    <div class="student-select">
                        {% for student in students %}
                        <label class="student-checkbox">
                            <input type="checkbox" 
                                   name="shared_students[]" 
                                   value="{{ student.id }}">
                            {{ student.profile.display_name|default:student.username }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- æäº¤æŒ‰éˆ• -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="history.back()">
                    <i class="fas fa-times"></i> å–æ¶ˆ
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-upload"></i> ä¸Šå‚³è³‡æº
                </button>
            </div>
            
            <!-- ä¸Šå‚³é€²åº¦ -->
            <div class="upload-progress" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // æª”æ¡ˆä¸Šå‚³è™•ç†
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const selectedFile = document.getElementById('selectedFile');
    let selectedFileObj = null;
    
    // é»æ“Šä¸Šå‚³å€åŸŸ
    uploadArea.addEventListener('click', () => fileInput.click());
    
    // æ‹–æ”¾è™•ç†
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });
    
    // æª”æ¡ˆé¸æ“‡è™•ç†
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    // è™•ç†é¸æ“‡çš„æª”æ¡ˆ
    function handleFileSelect(file) {
        selectedFileObj = file;
        
        // æª¢æŸ¥æª”æ¡ˆå¤§å°
        const maxSize = 50 * 1024 * 1024; // 50MB
        if (file.size > maxSize) {
            showError('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 50MB');
            return;
        }
        
        // é¡¯ç¤ºé¸æ“‡çš„æª”æ¡ˆ
        const fileIcon = getFileIcon(file.type);
        const fileSize = formatFileSize(file.size);
        
        selectedFile.innerHTML = `
            <div class="selected-file">
                <i class="${fileIcon} file-icon"></i>
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize}</div>
                </div>
                <button type="button" class="remove-file" onclick="removeFile()">
                    <i class="fas fa-times"></i> ç§»é™¤
                </button>
            </div>
        `;
        selectedFile.style.display = 'block';
        
        // è‡ªå‹•åµæ¸¬è³‡æºé¡å‹
        const resourceType = detectResourceType(file.type, file.name);
        document.querySelector('select[name="resource_type"]').value = resourceType;
    }
    
    // ç²å–æª”æ¡ˆåœ–æ¨™
    function getFileIcon(fileType) {
        if (fileType.includes('pdf')) return 'fas fa-file-pdf';
        if (fileType.includes('video')) return 'fas fa-file-video';
        if (fileType.includes('audio')) return 'fas fa-file-audio';
        if (fileType.includes('image')) return 'fas fa-file-image';
        return 'fas fa-file';
    }
    
    // æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    // åµæ¸¬è³‡æºé¡å‹
    function detectResourceType(mimeType, fileName) {
        if (mimeType.includes('pdf') || fileName.endsWith('.pdf')) return 'pdf';
        if (mimeType.includes('video')) return 'video';
        if (mimeType.includes('audio')) return 'audio';
        if (mimeType.includes('image')) return 'image';
        return 'other';
    }
    
    // ç§»é™¤æª”æ¡ˆ
    window.removeFile = function() {
        selectedFileObj = null;
        fileInput.value = '';
        selectedFile.style.display = 'none';
    };
    
    // æ¨™ç±¤è™•ç†
    const tagsContainer = document.getElementById('tagsContainer');
    const tagInput = document.getElementById('tagInput');
    const tagsHidden = document.getElementById('tagsHidden');
    let tags = [];
    
    tagInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            const tag = tagInput.value.trim();
            if (tag && !tags.includes(tag)) {
                addTag(tag);
                tagInput.value = '';
            }
        }
    });
    
    function addTag(tag) {
        tags.push(tag);
        updateTagsDisplay();
        updateTagsHidden();
    }
    
    function removeTag(tag) {
        tags = tags.filter(t => t !== tag);
        updateTagsDisplay();
        updateTagsHidden();
    }
    
    function updateTagsDisplay() {
        const tagElements = tags.map(tag => `
            <span class="tag-item">
                ${tag}
                <span class="tag-remove" onclick="removeTag('${tag}')">&times;</span>
            </span>
        `).join('');
        
        // æ¸…é™¤èˆŠæ¨™ç±¤ï¼Œä¿ç•™è¼¸å…¥æ¡†
        const existingTags = tagsContainer.querySelectorAll('.tag-item');
        existingTags.forEach(tag => tag.remove());
        
        // æ’å…¥æ–°æ¨™ç±¤
        tagsContainer.insertAdjacentHTML('afterbegin', tagElements);
    }
    
    function updateTagsHidden() {
        tagsHidden.value = tags.join(',');
    }
    
    window.removeTag = removeTag;
    
    // è¡¨å–®æäº¤
    const uploadForm = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // é©—è­‰
        if (!fileInput.files.length && !document.querySelector('input[name="external_link"]').value) {
            showError('è«‹é¸æ“‡æª”æ¡ˆæˆ–æä¾›å¤–éƒ¨é€£çµ');
            return;
        }
        
        // æº–å‚™è¡¨å–®æ•¸æ“š
        const formData = new FormData(uploadForm);
        
        // é¡¯ç¤ºé€²åº¦æ¢
        submitBtn.disabled = true;
        uploadProgress.style.display = 'block';
        
        try {
            const response = await uploadWithProgress(formData);
            
            if (response.success) {
                showSuccess('è³‡æºä¸Šå‚³æˆåŠŸï¼');
                setTimeout(() => {
                    window.location.href = "{% url 'practice_logs:teacher_resources' %}";
                }, 1500);
            } else {
                showError(response.error || 'ä¸Šå‚³å¤±æ•—');
                submitBtn.disabled = false;
            }
        } catch (error) {
            showError('ä¸Šå‚³éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤');
            submitBtn.disabled = false;
        }
    });
    
    // å¸¶é€²åº¦çš„ä¸Šå‚³
    function uploadWithProgress(formData) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressFill.style.width = percentComplete + '%';
                    progressFill.textContent = Math.round(percentComplete) + '%';
                }
            });
            
            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        resolve(response);
                    } catch (e) {
                        reject(new Error('Invalid response'));
                    }
                } else {
                    reject(new Error('Upload failed'));
                }
            });
            
            xhr.addEventListener('error', () => reject(new Error('Network error')));
            
            xhr.open('POST', uploadForm.action);
            xhr.send(formData);
        });
    }
    
    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(message) {
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }
    
    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
    function showSuccess(message) {
        const successMessage = document.getElementById('successMessage');
        successMessage.textContent = message;
        successMessage.style.display = 'block';
    }
});
</script>
{% endblock %}