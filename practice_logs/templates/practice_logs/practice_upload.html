{% extends "practice_logs/base.html" %}
{% load static %}

{% block title %}ç·´ç¿’è¨˜éŒ„ä¸Šå‚³ - å°æç´ç·´ç¿’è¿½è¹¤ç³»çµ±{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/classical_theme.css' %}">
<style>
    .practice-form-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
    }
    
    .form-section {
        margin-bottom: 3rem;
    }
    
    .rating-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin: 2rem 0;
    }
    
    .rating-item {
        text-align: center;
    }
    
    .rating-label {
        font-family: 'Playfair Display', serif;
        color: #722F37;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .rating-description {
        font-size: 0.9rem;
        color: #556B2F;
        margin-bottom: 1rem;
        font-style: italic;
    }
    
    .rating-placeholder {
        padding: 2rem;
        text-align: center;
        background: rgba(184, 134, 11, 0.05);
        border-radius: 8px;
        border: 2px dashed rgba(184, 134, 11, 0.3);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/classical_animations.js' %}"></script>
<script src="{% static 'js/video_upload.js' %}"></script>
{% endblock %}

{% block content %}
<div class="practice-form-container">
    <!-- é é¢æ¨™é¡Œ -->
    <h1 class="elegant-title">ğŸ» ç·´ç¿’è¨˜éŒ„ä¸Šå‚³</h1>
    
    <!-- ä¸»è¡¨å–® -->
    <form class="form-classical" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- åŸºæœ¬è³‡è¨Šå€å¡Š -->
        <div class="form-section parchment-card">
            <h3>ğŸ“ åŸºæœ¬ç·´ç¿’è³‡è¨Š</h3>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label-classical" for="student_name">å­¸ç”Ÿå§“å</label>
                    <input type="text" class="form-control form-control-classical" 
                           id="student_name" name="student_name" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label-classical" for="practice_date">ç·´ç¿’æ—¥æœŸ</label>
                    <input type="date" class="form-control form-control-classical" 
                           id="practice_date" name="date" required>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label class="form-label-classical" for="piece">ç·´ç¿’æ›²ç›®</label>
                    <input type="text" class="form-control form-control-classical" 
                           id="piece" name="piece" placeholder="ä¾‹å¦‚ï¼šå·´å“ˆ Gå¼¦ä¹‹æ­Œ" required>
                </div>
                
                <div class="col-md-4 mb-3">
                    <label class="form-label-classical" for="minutes">ç·´ç¿’æ™‚é–“ (åˆ†é˜)</label>
                    <input type="number" class="form-control form-control-classical" 
                           id="minutes" name="minutes" min="1" max="600" required>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label-classical" for="focus">ç·´ç¿’é‡é»</label>
                <select class="form-control form-control-classical" id="focus" name="focus">
                    <option value="technique">æŠ€å·§ç·´ç¿’</option>
                    <option value="expression">è¡¨ç¾åŠ›</option>
                    <option value="rhythm">ç¯€å¥</option>
                    <option value="sight_reading">è¦–å¥</option>
                    <option value="memorization">è¨˜è­œ</option>
                    <option value="ensemble">é‡å¥</option>
                    <option value="other">å…¶ä»–</option>
                </select>
            </div>
        </div>
        
        <!-- å½±ç‰‡ä¸Šå‚³å€å¡Š -->
        <div class="form-section">
            <h3>ğŸ¥ ç·´ç¿’å½±ç‰‡ä¸Šå‚³</h3>
            <div class="video-upload-area classical-border">
                <div class="upload-icon">ğŸ¬</div>
                <div class="upload-text">æ‹–æ‹½å½±ç‰‡åˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡</div>
                <div class="upload-hint">æ”¯æ´ MP4, AVI, MOV, WebM æ ¼å¼ï¼Œæœ€å¤§ 100MB</div>
            </div>
        </div>
        
        <!-- å¿ƒæƒ…é¸æ“‡å€å¡Š -->
        <div class="form-section parchment-card">
            <h3>ğŸ­ ç·´ç¿’å¿ƒæƒ…</h3>
            <p class="text-muted mb-3">é¸æ“‡æœ€è²¼è¿‘ä»Šæ—¥ç·´ç¿’æ™‚å¿ƒæƒ…çš„å¤å…¸ä½œæ›²å®¶é¢¨æ ¼</p>
            
            <div class="mood-selector">
                <label class="mood-option" for="mood_joyful">
                    <input type="radio" name="mood" value="joyful" id="mood_joyful" style="display: none;">
                    <span class="mood-emoji">ğŸ˜Š</span>
                    <span class="mood-label">æ„‰æ‚…å¦‚è«æœ­ç‰¹</span>
                </label>
                
                <label class="mood-option" for="mood_peaceful">
                    <input type="radio" name="mood" value="peaceful" id="mood_peaceful" style="display: none;">
                    <span class="mood-emoji">ğŸ˜Œ</span>
                    <span class="mood-label">å¹³éœå¦‚å¾·å¸ƒè¥¿</span>
                </label>
                
                <label class="mood-option" for="mood_focused">
                    <input type="radio" name="mood" value="focused" id="mood_focused" style="display: none;" checked>
                    <span class="mood-emoji">ğŸ¯</span>
                    <span class="mood-label">å°ˆæ³¨å¦‚å·´å“ˆ</span>
                </label>
                
                <label class="mood-option" for="mood_melancholic">
                    <input type="radio" name="mood" value="melancholic" id="mood_melancholic" style="display: none;">
                    <span class="mood-emoji">ğŸ˜”</span>
                    <span class="mood-label">æ†‚é¬±å¦‚è•­é‚¦</span>
                </label>
                
                <label class="mood-option" for="mood_passionate">
                    <input type="radio" name="mood" value="passionate" id="mood_passionate" style="display: none;">
                    <span class="mood-emoji">ğŸ”¥</span>
                    <span class="mood-label">ç†±æƒ…å¦‚æŸ´å¯å¤«æ–¯åŸº</span>
                </label>
                
                <label class="mood-option" for="mood_contemplative">
                    <input type="radio" name="mood" value="contemplative" id="mood_contemplative" style="display: none;">
                    <span class="mood-emoji">ğŸ¤”</span>
                    <span class="mood-label">æ²‰æ€å¦‚è²å¤šèŠ¬</span>
                </label>
            </div>
        </div>
        
        <!-- å‹•æ…‹è©•åˆ†å€å¡Š (æ ¹æ“šç·´ç¿’é‡é») -->
        <div class="form-section parchment-card">
            <h3>â­ ç·´ç¿’é‡é»è‡ªæˆ‘è©•åˆ†</h3>
            <p class="text-muted mb-3">æ ¹æ“šé¸æ“‡çš„ç·´ç¿’é‡é»ï¼Œç”¨éŸ³ç¬¦ç‚ºç›¸é—œæŠ€èƒ½è©•åˆ† (1-5 éŸ³ç¬¦)</p>
            
            <div id="dynamic-rating-section" class="rating-section">
                <!-- å‹•æ…‹è¼‰å…¥è©•åˆ†é …ç›® -->
                <div class="rating-placeholder">
                    <p class="text-center text-muted">è«‹å…ˆé¸æ“‡ç·´ç¿’é‡é»</p>
                </div>
            </div>
        </div>
        
        <!-- ç·´ç¿’ç­†è¨˜å€å¡Š -->
        <div class="form-section parchment-card">
            <h3>ğŸ“” ç·´ç¿’è¨˜éŒ„</h3>
            
            <div class="mb-3">
                <label class="form-label-classical" for="notes">ç·´ç¿’å¿ƒå¾—èˆ‡è§€å¯Ÿ</label>
                <textarea class="form-control form-control-classical" id="notes" name="notes" 
                         rows="4" placeholder="è¨˜éŒ„ä»Šæ—¥ç·´ç¿’çš„å¿ƒå¾—ã€ç™¼ç¾çš„å•é¡Œæˆ–çªç ´..."></textarea>
            </div>
            
            <div class="mb-3">
                <label class="form-label-classical" for="student_notes_to_teacher">çµ¦è€å¸«çš„è©±</label>
                <textarea class="form-control form-control-classical" id="student_notes_to_teacher" 
                         name="student_notes_to_teacher" rows="3" 
                         placeholder="æƒ³å°è€å¸«èªªçš„è©±ï¼Œæˆ–éœ€è¦æŒ‡å°çš„åœ°æ–¹..."></textarea>
            </div>
        </div>
        
        <!-- æäº¤æŒ‰éˆ• -->
        <div class="text-center">
            <button type="submit" class="btn-classical btn-lg">
                ğŸ¼ æäº¤ç·´ç¿’è¨˜éŒ„
            </button>
            <button type="button" class="btn-burgundy btn-lg ms-3" onclick="history.back()">
                è¿”å›
            </button>
        </div>
    </form>
</div>

<!-- JavaScript åˆå§‹åŒ– -->
<script>
// ç·´ç¿’é‡é»è©•åˆ†é…ç½® (èˆ‡å¾Œç«¯ä¿æŒä¸€è‡´)
const FOCUS_RATING_CONFIG = {
    'technique': {
        'name': 'æŠ€å·§ç·´ç¿’',
        'ratings': [
            ['technique_bow_control', 'é‹å¼“æ§åˆ¶', 'é‹å¼“æŠ€å·§å’Œæ§åˆ¶åŠ›'],
            ['technique_finger_position', 'æŒ‰å¼¦æº–ç¢ºåº¦', 'å·¦æ‰‹æŒ‰å¼¦ä½ç½®æº–ç¢ºæ€§'],
            ['technique_intonation', 'éŸ³æº–', 'éŸ³é«˜æº–ç¢ºåº¦'],
        ]
    },
    'expression': {
        'name': 'è¡¨ç¾åŠ›',
        'ratings': [
            ['expression_dynamics', 'åŠ›åº¦è®ŠåŒ–', 'éŸ³é‡å¼·å¼±çš„è¡¨ç¾æ§åˆ¶'],
            ['expression_phrasing', 'æ¨‚å¥è™•ç†', 'éŸ³æ¨‚ç·šæ¢èˆ‡æ¨‚å¥è¡¨ç¾'],
            ['expression_emotion', 'æƒ…æ„Ÿè¡¨é”', 'éŸ³æ¨‚æƒ…æ„Ÿçš„å‚³é”'],
        ]
    },
    'rhythm': {
        'name': 'ç¯€å¥',
        'ratings': [
            ['rhythm_tempo_stability', 'é€Ÿåº¦ç©©å®šåº¦', 'ç¯€æ‹é€Ÿåº¦ä¿æŒç©©å®š'],
            ['rhythm_pattern_accuracy', 'ç¯€å¥å‹æº–ç¢ºåº¦', 'è¤‡é›œç¯€å¥å‹çš„æº–ç¢ºæ¼”å¥'],
            ['technique_intonation', 'éŸ³æº–é…åˆ', 'ç¯€å¥ä¸­çš„éŸ³æº–ç¶­æŒ'],
        ]
    },
    'sight_reading': {
        'name': 'è¦–å¥',
        'ratings': [
            ['sight_reading_fluency', 'è¦–å¥æµæš¢åº¦', 'ç¬¬ä¸€æ¬¡çœ‹è­œæ¼”å¥çš„æµæš¢ç¨‹åº¦'],
            ['sight_reading_accuracy', 'è¦–å¥æº–ç¢ºåº¦', 'éŸ³ç¬¦ã€ç¯€å¥è®€è­œæº–ç¢ºåº¦'],
            ['rhythm_tempo_stability', 'é€Ÿåº¦æ§åˆ¶', 'è¦–å¥æ™‚çš„é€Ÿåº¦ç©©å®šæ€§'],
        ]
    },
    'memorization': {
        'name': 'è¨˜è­œ',
        'ratings': [
            ['memorization_stability', 'è¨˜æ†¶ç©©å®šåº¦', 'èƒŒè­œæ¼”å¥çš„ç©©å®šç¨‹åº¦'],
            ['memorization_confidence', 'è¨˜è­œä¿¡å¿ƒ', 'èƒŒè­œæ¼”å¥çš„è‡ªä¿¡ç¨‹åº¦'],
            ['technique_intonation', 'éŸ³æº–ç©©å®š', 'èƒŒè­œæ™‚çš„éŸ³æº–ç¶­æŒ'],
        ]
    },
    'ensemble': {
        'name': 'é‡å¥',
        'ratings': [
            ['ensemble_listening', 'è†è½é…åˆ', 'èˆ‡å…¶ä»–è²éƒ¨çš„è†è½é…åˆ'],
            ['ensemble_timing', 'æ™‚é–“åŒæ­¥', 'èˆ‡å…¶ä»–æ¨‚å™¨çš„æ™‚é–“åŒæ­¥'],
            ['expression_dynamics', 'éŸ³é‡å¹³è¡¡', 'åœ¨åˆå¥ä¸­çš„éŸ³é‡æ§åˆ¶'],
        ]
    },
    'other': {
        'name': 'å…¶ä»–',
        'ratings': [
            ['technique_bow_control', 'æŠ€å·§è¡¨ç¾', 'æ•´é«”æŠ€å·§å±•ç¾'],
            ['expression_emotion', 'éŸ³æ¨‚è¡¨ç¾', 'æ•´é«”éŸ³æ¨‚æ€§è¡¨ç¾'],
            ['rhythm_tempo_stability', 'ç©©å®šåº¦', 'æ•´é«”æ¼”å¥ç©©å®šæ€§'],
        ]
    }
};

document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–å¿ƒæƒ…é¸æ“‡å™¨
    initMoodSelector();
    
    // è¨­ç½®è¡¨å–®é©—è­‰
    setupFormValidation();
    
    // è¨­ç½®ä»Šæ—¥æ—¥æœŸ
    document.getElementById('practice_date').value = new Date().toISOString().split('T')[0];
    
    // åˆå§‹åŒ–å‹•æ…‹è©•åˆ†ç³»çµ±
    initDynamicRatingSystem();
    
    // åˆå§‹åŒ–æµ®å‹•éŸ³ç¬¦æ•ˆæœ
    if (window.classicalAnimations) {
        window.classicalAnimations.createFloatingNotes();
    }
});

function initMoodSelector() {
    document.querySelectorAll('.mood-option').forEach(option => {
        option.addEventListener('click', function() {
            // ç§»é™¤å…¶ä»–é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.mood-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // æ·»åŠ é¸ä¸­ç‹€æ…‹
            this.classList.add('selected');
            
            // é¸ä¸­å°æ‡‰çš„radio button
            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;
            
            // æ’­æ”¾éŸ³æ•ˆ
            if (window.classicalAnimations) {
                window.classicalAnimations.playHoverSound();
            }
        });
    });
    
    // è¨­ç½®é è¨­é¸ä¸­é …
    document.querySelector('input[name="mood"]:checked').closest('.mood-option').classList.add('selected');
}

function initDynamicRatingSystem() {
    const focusSelect = document.getElementById('focus');
    
    if (!focusSelect) {
        console.error('ç·´ç¿’é‡é»é¸æ“‡å™¨æœªæ‰¾åˆ°');
        return;
    }
    
    console.log('åˆå§‹åŒ–å‹•æ…‹è©•åˆ†ç³»çµ±ï¼Œç•¶å‰é¸é …:', focusSelect.value);
    
    // ç›£è½ç·´ç¿’é‡é»è®ŠåŒ–
    focusSelect.addEventListener('change', function() {
        console.log('ç·´ç¿’é‡é»è®Šæ›´ç‚º:', this.value);
        updateRatingSection(this.value);
    });
    
    // åˆå§‹åŒ–é è¨­è©•åˆ†å€å¡Š
    updateRatingSection(focusSelect.value);
}

function updateRatingSection(focusType) {
    const ratingSection = document.getElementById('dynamic-rating-section');
    
    if (!ratingSection) {
        console.error('è©•åˆ†å€åŸŸå…ƒç´ æœªæ‰¾åˆ°');
        return;
    }
    
    console.log('æ›´æ–°è©•åˆ†å€å¡Šï¼Œé¡å‹:', focusType);
    
    if (!FOCUS_RATING_CONFIG[focusType]) {
        console.error('æ‰¾ä¸åˆ°é…ç½®:', focusType);
        ratingSection.innerHTML = '<div class="rating-placeholder"><p class="text-center text-muted">æ‰¾ä¸åˆ°å°æ‡‰çš„è©•åˆ†é…ç½®</p></div>';
        return;
    }
    
    const config = FOCUS_RATING_CONFIG[focusType];
    let html = '';
    
    config.ratings.forEach(([fieldName, displayName, description]) => {
        html += `
            <div class="rating-item">
                <label class="rating-label">${displayName}</label>
                <p class="rating-description">${description}</p>
                <div class="rating-stars" data-field="${fieldName}">
                    <span class="rating-star musical-note" data-value="1"></span>
                    <span class="rating-star musical-note" data-value="2"></span>
                    <span class="rating-star musical-note" data-value="3"></span>
                    <span class="rating-star musical-note" data-value="4"></span>
                    <span class="rating-star musical-note" data-value="5"></span>
                </div>
                <input type="hidden" name="${fieldName}" value="3">
            </div>
        `;
    });
    
    ratingSection.innerHTML = html;
    console.log('è©•åˆ†HTMLå·²æ›´æ–°ï¼Œå…±æœ‰', config.ratings.length, 'å€‹è©•åˆ†é …ç›®');
    
    // é‡æ–°åˆå§‹åŒ–æ˜Ÿç´šè©•åˆ†
    initRatingStars();
    
    // æ·»åŠ å‹•ç•«æ•ˆæœ
    ratingSection.style.animation = 'fadeInUp 0.5s ease-out';
    
    // ç¢ºä¿å‹•ç•«å¾Œæ¸…é™¤æ¨£å¼
    setTimeout(() => {
        ratingSection.style.animation = '';
    }, 500);
}

function initRatingStars() {
    document.querySelectorAll('.rating-stars').forEach(ratingContainer => {
        const stars = ratingContainer.querySelectorAll('.rating-star');
        const hiddenInput = ratingContainer.parentElement.querySelector('input[type="hidden"]');
        const currentRating = parseInt(hiddenInput.value);
        
        // è¨­ç½®åˆå§‹è©•åˆ†é¡¯ç¤º
        updateStarDisplay(stars, currentRating);
        
        stars.forEach((star, index) => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.dataset.value);
                hiddenInput.value = rating;
                updateStarDisplay(stars, rating);
                
                // æ’­æ”¾éŸ³æ•ˆ
                if (window.classicalAnimations) {
                    window.classicalAnimations.playHoverSound();
                }
                
                // æ·»åŠ é»æ“Šå‹•ç•«
                this.style.animation = 'starTwinkle 0.5s ease-in-out';
                setTimeout(() => {
                    this.style.animation = '';
                }, 500);
            });
            
            star.addEventListener('mouseenter', function() {
                const rating = parseInt(this.dataset.value);
                updateStarDisplay(stars, rating);
            });
        });
        
        ratingContainer.addEventListener('mouseleave', function() {
            const currentRating = parseInt(hiddenInput.value);
            updateStarDisplay(stars, currentRating);
        });
    });
}

function updateStarDisplay(stars, rating) {
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}

function setupFormValidation() {
    const form = document.querySelector('form');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // åŸºæœ¬é©—è­‰
        if (!this.checkValidity()) {
            this.reportValidity();
            return;
        }
        
        // é¡¯ç¤ºæäº¤å‹•ç•«
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = 'ğŸµ æäº¤ä¸­...';
        submitBtn.disabled = true;
        
        // æ¨¡æ“¬æäº¤éç¨‹
        setTimeout(() => {
            // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            if (window.classicalAnimations) {
                window.classicalAnimations.playSuccessChord();
            }
            
            // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
            showSuccessMessage();
            
            // é‡ç½®æŒ‰éˆ•
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            // å¯¦éš›æäº¤è¡¨å–® (ç§»é™¤preventDefault)
            // this.submit();
        }, 2000);
    });
}

function showSuccessMessage() {
    const successModal = document.createElement('div');
    successModal.innerHTML = `
        <div style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        ">
            <div style="
                background: linear-gradient(135deg, #FDF5E6, #F4F1E8);
                border-radius: 20px;
                padding: 3rem;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                border: 3px solid #B8860B;
                max-width: 500px;
            ">
                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ‰</div>
                <h2 style="font-family: 'Playfair Display', serif; color: #722F37; margin-bottom: 1rem;">
                    ç·´ç¿’è¨˜éŒ„æäº¤æˆåŠŸï¼
                </h2>
                <p style="font-family: 'Crimson Text', serif; color: #556B2F; font-size: 1.2rem;">
                    æ‚¨çš„ç·´ç¿’è¨˜éŒ„å·²æˆåŠŸä¿å­˜ï¼Œç¹¼çºŒä¿æŒå„ªç§€çš„ç·´ç¿’ç¿’æ…£ï¼
                </p>
                <button onclick="this.closest('div').remove()" 
                        style="
                            background: linear-gradient(135deg, #B8860B, #FFBF00);
                            border: none;
                            color: #191970;
                            font-family: 'Playfair Display', serif;
                            font-weight: 600;
                            padding: 0.75rem 2rem;
                            border-radius: 8px;
                            margin-top: 1rem;
                            cursor: pointer;
                        ">
                    ç¹¼çºŒç·´ç¿’
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(successModal);
    
    // 3ç§’å¾Œè‡ªå‹•é—œé–‰
    setTimeout(() => {
        successModal.remove();
    }, 3000);
}
</script>
{% endblock %}