{% extends "practice_logs/base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <h1>ğŸ» å°æç´ç·´ç´æ—¥èªŒ</h1>

    <!-- éŒ¯èª¤æç¤ºå€åŸŸ -->
    <div id="errorAlert" class="alert alert-danger alert-dismissible fade d-none" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="errorMessage"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <form method='POST' id="practiceForm">
        {% csrf_token %}
        <div class="form-group" data-label="å­¸ç”Ÿå§“å">
            <input type="text" name="student_name" id="studentName" placeholder="è«‹è¼¸å…¥å­¸ç”Ÿå§“å" required
                value="{{ current_student|default:'' }}" maxlength="50" pattern="[^<>]*">
        </div>
        <div class="form-group" data-label="æ›²ç›®åç¨±">
            <input type="text" name="piece" placeholder="è«‹è¼¸å…¥ç·´ç¿’æ›²ç›®" required maxlength="100">
        </div>
        <div class="form-group" data-label="ç·´ç¿’æ™‚é–“">
            <input type="number" name="minutes" placeholder="è«‹è¼¸å…¥ç·´ç¿’æ™‚é–“ï¼ˆåˆ†é˜ï¼‰" min="1" max="600" required>
        </div>
        <div class="form-group" data-label="ç·´ç¿’è©•åˆ†">
            <select name="rating" required>
                <option value="" disabled selected>è«‹é¸æ“‡ä»Šæ—¥ç·´ç¿’è©•åˆ†</option>
                {% for i in "12345" %}
                <option value="{{ i }}">{{ i }} æ˜Ÿ â­</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" data-label="ç·´ç¿’é‡é»">
            <select name="focus" required>
                <option value="" disabled selected>è«‹é¸æ“‡ç·´ç¿’é‡é»</option>
                {% for focus_code, focus_name in focus_choices %}
                <option value="{{ focus_code }}">{{ focus_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" data-label="ç·´ç¿’ç­†è¨˜">
            <textarea name="notes" placeholder="è¨˜éŒ„ä»Šå¤©çš„ç·´ç¿’å¿ƒå¾—ï¼ˆé¸å¡«ï¼‰" rows="3" maxlength="1000"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            è¨˜éŒ„ç·´ç¿’ âœ¨
        </button>
    </form>

    <div class="chart-container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>ğŸµ ç·´ç¿’æ™‚é–“çµ±è¨ˆ</h2>
            <div id="analyticsLink">
                <a href="#" class="btn btn-primary" onclick="goToAnalytics(); return false;">
                    æŸ¥çœ‹è©³ç´°åˆ†æ ğŸ“Š
                </a>
            </div>
        </div>
        <div id="studentInfo" class="student-info text-center mb-3"></div>
        <div class="chart-wrapper position-relative">
            <div id="chartLoading" class="position-absolute top-50 start-50 translate-middle d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                </div>
            </div>
            <canvas id="weeklyChart"></canvas>
        </div>
    </div>
</div>

<style>
    .form-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    .form-group::before {
        content: attr(data-label);
        position: absolute;
        top: -0.75rem;
        left: 1rem;
        padding: 0 0.5rem;
        background-color: white;
        font-size: 0.875rem;
        color: #666;
        z-index: 1;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        border-color: #7c4dff;
        box-shadow: 0 0 0 3px rgba(124, 77, 255, 0.1);
        outline: none;
    }

    .form-group input::placeholder,
    .form-group select::placeholder,
    .form-group textarea::placeholder {
        color: #999;
    }

    .form-group select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 11.5l-5-5h10l-5 5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        padding-right: 2.5rem;
    }

    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }

    .btn-primary {
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(124, 77, 255, 0.2);
    }

    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .student-info {
        font-size: 1.2rem;
        color: #666;
        margin: 1rem 0;
    }
</style>

<!-- å°‡ Django è®Šé‡å‚³éçµ¦ JavaScript -->
<script>
    window.INITIAL_STUDENT = "{{ current_student|default:'null' }}";
    window.CSRF_TOKEN = "{{ csrf_token }}";
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
    // å°å…¥æ‰€éœ€æ¨¡çµ„
    import { loadWeeklyData } from '{% static "js/charts/charts.js" %}';
    import { setupChartDefaults } from '{% static "js/charts/config.js" %}';
    import { handleError } from '{% static "js/utils.js" %}';

    // ç­‰å¾… Chart.js è¼‰å…¥
    async function waitForChart() {
        if (typeof Chart !== 'undefined') return;

        return new Promise((resolve) => {
            const checkChart = () => {
                if (typeof Chart !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(checkChart, 50);
                }
            };
            checkChart();
        });
    }

    // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
    function showError(message) {
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = message;
        errorAlert.classList.remove('d-none');
        errorAlert.classList.add('show');
    }

    // é¡¯ç¤º/éš±è—è¼‰å…¥å‹•ç•«
    function toggleLoading(show) {
        const loadingSpinner = document.querySelector('.spinner-border');
        const chartLoading = document.getElementById('chartLoading');
        if (show) {
            loadingSpinner.classList.remove('d-none');
            chartLoading.classList.remove('d-none');
        } else {
            loadingSpinner.classList.add('d-none');
            chartLoading.classList.add('d-none');
        }
    }

    async function initializeApp() {
        try {
            // ç­‰å¾… Chart.js
            await waitForChart();

            // è¨­ç½®åœ–è¡¨é è¨­å€¼
            setupChartDefaults();

            // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦æœ‰ç•¶å‰å­¸ç”Ÿ
            const currentStudent = window.INITIAL_STUDENT === "null" ? null : window.INITIAL_STUDENT;
            const savedStudent = localStorage.getItem('currentStudent');
            const studentToLoad = currentStudent || savedStudent;

            if (studentToLoad) {
                document.getElementById('studentName').value = studentToLoad;
                try {
                    toggleLoading(true);
                    await loadWeeklyData(studentToLoad);
                } catch (error) {
                    showError('è¼‰å…¥åœ–è¡¨æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                } finally {
                    toggleLoading(false);
                }
            }

            // è¡¨å–®æäº¤è™•ç†
            document.getElementById('practiceForm').addEventListener('submit', async function (e) {
                e.preventDefault();
                const form = this;
                const studentName = document.getElementById('studentName').value;

                try {
                    toggleLoading(true);
                    const formData = new FormData(form);
                    const data = {};
                    formData.forEach((value, key) => {
                        data[key] = value;
                    });

                    const response = await fetch('', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.CSRF_TOKEN,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.redirected) {
                        // å¦‚æœå¾Œç«¯è¿”å›é‡å®šå‘ï¼Œæˆ‘å€‘å°±è·Ÿéš¨é‡å®šå‘
                        window.location.href = response.url;
                        return;
                    }

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'æäº¤ç·´ç¿’è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤');
                    }

                    // ä¿å­˜ç•¶å‰å­¸ç”Ÿ
                    localStorage.setItem('currentStudent', studentName);

                    // é‡ç½®è¡¨å–®
                    form.reset();
                    document.getElementById('studentName').value = studentName;

                    // é‡æ–°è¼‰å…¥åœ–è¡¨
                    await loadWeeklyData(studentName);

                    // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success alert-dismissible fade show';
                    successAlert.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        ç·´ç¿’è¨˜éŒ„å·²ä¿å­˜æˆåŠŸï¼
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    form.insertAdjacentElement('beforebegin', successAlert);

                    // 3ç§’å¾Œè‡ªå‹•é—œé–‰æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        successAlert.remove();
                    }, 3000);

                } catch (error) {
                    showError(error.message);
                } finally {
                    toggleLoading(false);
                }
            });

        } catch (error) {
            console.error('åˆå§‹åŒ–å¤±æ•—:', error);
            showError('åˆå§‹åŒ–æ‡‰ç”¨æ™‚ç™¼ç”ŸéŒ¯èª¤');
        }
    }

    // å°èˆªåˆ°åˆ†æé é¢
    window.goToAnalytics = function () {
        const studentName = document.getElementById('studentName').value;
        if (studentName) {
            window.location.href = `/analytics/${encodeURIComponent(studentName)}/`;
        } else {
            showError('è«‹å…ˆè¼¸å…¥å­¸ç”Ÿå§“å');
        }
    };

    // å•Ÿå‹•æ‡‰ç”¨
    initializeApp().catch(error => {
        console.error('æ‡‰ç”¨å•Ÿå‹•å¤±æ•—:', error);
        showError('æ‡‰ç”¨å•Ÿå‹•å¤±æ•—');
    });
</script>
{% endblock %}